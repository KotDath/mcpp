---
phase: 06-high-level-api
plan: 05
type: execute
wave: 3
depends_on: ["06-01", "06-02", "06-03", "06-04"]
files_modified:
  - src/mcpp/util/retry.h
  - CMakeLists.txt
autonomous: true

must_haves:
  truths:
    - "RetryPolicy template with exponential backoff strategy"
    - "All new API and util headers are exported in CMakeLists.txt"
  artifacts:
    - path: "src/mcpp/util/retry.h"
      provides: "Retry with backoff strategies"
      exports: ["template<typename T> class RetryPolicy", "class ExponentialBackoff"]
    - path: "CMakeLists.txt"
      provides: "Build configuration for all Phase 6 headers"
      contains: "MCPP_PUBLIC_HEADERS"
  key_links:
    - from: "src/mcpp/util/retry.h"
      to: "src/mcpp/util/error.h"
      via: "include"
      pattern: "#include.*error.h"
    - from: "CMakeLists.txt"
      to: "src/mcpp/api/*.h"
      via: "MCPP_PUBLIC_HEADERS"
      pattern: "api/|util/"
---

<objective>
Retry strategies and build configuration updates for Phase 6 high-level API.

Purpose: Provide pluggable retry policies with exponential backoff for transient failures, and ensure all new API and utility headers are properly exported in the build system. Retry functionality adds resilience for network operations and unreliable transports.

Output: RetryPolicy template with ExponentialBackoff implementation, and updated CMakeLists.txt with all Phase 6 headers.
</objective>

<execution_context>
@/home/kotdath/.claude/get-shit-done/workflows/execute-plan.md
@/home/kotdath/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-high-level-api/06-CONTEXT.md
@.planning/phases/06-high-level-api/06-RESEARCH.md
@.planning/phases/06-high-level-api/06-01-SUMMARY.md
@.planning/phases/06-high-level-api/06-02-SUMMARY.md
@.planning/phases/06-high-level-api/06-03-SUMMARY.md
@.planning/phases/06-high-level-api/06-04-SUMMARY.md
@thirdparty/gopher-mcp/sdk/go/src/filters/retry.go
@CMakeLists.txt
</context>

<tasks>

<task type="auto">
  <name>Create retry policy with backoff strategies</name>
  <files>src/mcpp/util/retry.h</files>
  <action>
Create src/mcpp/util/retry.h with:

1. RetryPolicy<T> template interface:
   - virtual std::chrono::milliseconds next_delay(int attempt) const = 0
   - virtual bool should_retry(const std::exception& e) const = 0
   - virtual ~RetryPolicy() = default

2. ExponentialBackoff policy:
   Members:
   - double initial_delay_ = 1000 (1 second)
   - double multiplier_ = 2.0
   - double max_delay_ = 30000 (30 seconds)

   Methods:
   - std::chrono::milliseconds next_delay(int attempt) const override
   - bool should_retry(const std::exception& e) const override (default: true for transient errors)

3. retry_with_backoff template function:
   ```cpp
   template<typename T>
   Result<T> retry_with_backoff(
       std::function<Result<T>()> fn,
       const RetryPolicy<T>& policy,
       int max_attempts = 3
   )
   ```
   - Loop max_attempts times
   - Call fn(), return result on success
   - On exception: check should_retry, sleep via next_delay, retry
   - Return last error if all attempts fail

4. Include <chrono>, <functional>, <exception>, <thread>, <cmath>
5. Include mcpp/util/error.h for error types

6. Namespace: mcpp::util

Follow gopher-mcp retry pattern from sdk/go/src/filters/retry.go.
  </action>
  <verify>
grep -q "class RetryPolicy" src/mcpp/util/retry.h && \
grep -q "class ExponentialBackoff" src/mcpp/util/retry.h && \
grep -q "retry_with_backoff" src/mcpp/util/retry.h && \
grep -q "next_delay" src/mcpp/util/retry.h
  </verify>
  <done>
Retry utilities provide:
- Pluggable retry policy interface
- Exponential backoff with configurable parameters
- Automatic retry with sleep between attempts
- Transient error detection
  </done>
</task>

<task type="auto">
  <name>Update CMakeLists.txt with all Phase 6 headers</name>
  <files>CMakeLists.txt</files>
  <action>
Update CMakeLists.txt:

1. Add all new API headers to MCPP_PUBLIC_HEADERS:
   - api/service.h
   - api/role.h
   - api/peer.h
   - api/running_service.h
   - api/context.h

2. Add all new util headers to MCPP_PUBLIC_HEADERS:
   - util/logger.h
   - util/pagination.h
   - util/error.h
   - util/retry.h

3. Add util/logger.cpp to MCPP_SOURCES

4. Ensure headers are grouped logically:
   - Core headers (already present)
   - Client headers (already present)
   - Server headers (already present)
   - API headers (new: src/mcpp/api/*.h)
   - Util headers (new: src/mcpp/util/*.h)

5. Add find_package(spdlog) if needed, with fallback to internal stub

6. Verify alphabetical ordering within groups

Follow existing CMakeLists.txt structure from Phase 3 (03-07-PLAN.md).
  </action>
  <verify>
grep -q "api/service.h" CMakeLists.txt && \
grep -q "api/role.h" CMakeLists.txt && \
grep -q "api/peer.h" CMakeLists.txt && \
grep -q "api/running_service.h" CMakeLists.txt && \
grep -q "api/context.h" CMakeLists.txt && \
grep -q "util/logger.h" CMakeLists.txt && \
grep -q "util/pagination.h" CMakeLists.txt && \
grep -q "util/error.h" CMakeLists.txt && \
grep -q "util/retry.h" CMakeLists.txt
  </verify>
  <done>
CMakeLists.txt includes:
- All new API headers in public headers list
- All new util headers in public headers list
- logger.cpp in sources
- spdlog dependency with fallback
  </done>
</task>

</tasks>

<verification>
1. ExponentialBackoff produces correct delay sequence (1s, 2s, 4s, 8s...)
2. retry_with_backoff retries on failure, returns success on first success
3. CMakeLists.txt lists all new headers for installation
4. Build succeeds with cmake --build .
</verification>

<success_criteria>
1. RetryPolicy interface allows pluggable backoff strategies
2. ExponentialBackoff implements standard exponential backoff
3. All new headers are exported for library consumers
4. Build system correctly includes logger.cpp source file
</success_criteria>

<output>
After completion, create `.planning/phases/06-high-level-api/06-05-SUMMARY.md` with:
- Tech stack added: Retry strategies with exponential backoff
- Patterns established: Pluggable retry policies
- Key files: src/mcpp/util/retry.h (updated CMakeLists.txt)
- Integration: All Phase 6 headers exported in build
</output>
