---
phase: 06-high-level-api
plan: 04
type: execute
wave: 3
depends_on: ["06-01", "06-02", "06-03"]
files_modified:
  - src/mcpp/util/pagination.h
  - src/mcpp/util/error.h
autonomous: true

must_haves:
  truths:
    - "list_all helper automatically paginates through cursor-based results"
    - "ServiceError hierarchy provides typed error categories with context preservation"
  artifacts:
    - path: "src/mcpp/util/pagination.h"
      provides: "list_all helper for automatic pagination"
      exports: ["template<typename T> list_all", "struct PaginatedRequest"]
    - path: "src/mcpp/util/error.h"
      provides: "Unified error types"
      exports: ["class ServiceError", "class TransportError", "class ProtocolError"]
  key_links:
    - from: "src/mcpp/util/pagination.h"
      to: "src/mcpp/content/pagination.h"
      via: "include"
      pattern: "#include.*pagination.h"
---

<objective>
Pagination helpers and unified error hierarchy for high-level API ergonomics.

Purpose: Provide helper utilities that eliminate manual cursor tracking and enable structured error handling. Pagination helper eliminates boilerplate for cursor-based list operations, while unified error types enable typed error handling with context preservation for debugging.

Output: list_all pagination helper and ServiceError hierarchy (TransportError, ProtocolError, RequestError).
</objective>

<execution_context>
@/home/kotdath/.claude/get-shit-done/workflows/execute-plan.md
@/home/kotdath/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-high-level-api/06-CONTEXT.md
@.planning/phases/06-high-level-api/06-RESEARCH.md
@.planning/phases/06-high-level-api/06-01-SUMMARY.md
@.planning/phases/06-high-level-api/06-02-SUMMARY.md
@.planning/phases/06-high-level-api/06-03-SUMMARY.md
@thirdparty/rust-sdk/crates/rmcp/src/service/client.rs
@src/mcpp/content/pagination.h
@src/mcpp/core/error.h
</context>

<tasks>

<task type="auto">
  <name>Create list_all pagination helper</name>
  <files>src/mcpp/util/pagination.h</files>
  <action>
Create src/mcpp/util/pagination.h with:

1. PaginatedRequest struct:
   - std::optional<std::string> cursor
   - Optional limit parameter

2. list_all template function:
   ```cpp
   template <typename T, typename ListFn>
   std::vector<T> list_all(ListFn&& list_fn) {
       std::vector<T> items;
       std::optional<std::string> cursor;

       do {
           auto page = list_fn(cursor);
           items.insert(items.end(),
                       std::make_move_iterator(page.items.begin()),
                       std::make_move_iterator(page.items.end()));
           cursor = page.next_cursor;
       } while (cursor);

       return items;
   }
   ```

3. Include mcpp/content/pagination.h for PaginatedResult
4. Include <vector>, <optional>, <functional>

5. Namespace: mcpp::util

Follow rust-sdk list_all pattern from service/client.rs.

Note: This is header-only template - no .cpp file needed.
  </action>
  <verify>
grep -q "list_all" src/mcpp/util/pagination.h && \
grep -q "template.*typename T" src/mcpp/util/pagination.h && \
grep -q "PaginatedResult" src/mcpp/util/pagination.h
  </verify>
  <done>
list_all helper:
- Accepts lambda or function returning PaginatedResult<T>
- Accumulates all items across pages
- Handles cursor pagination automatically
  </done>
</task>

<task type="auto">
  <name>Create unified error hierarchy</name>
  <files>src/mcpp/util/error.h</files>
  <action>
Create src/mcpp/util/error.h with:

1. ServiceError base class:
   - Inherits from std::runtime_error
   - Members: std::string message_, std::optional<int> code_, std::map<std::string, std::string> context_
   - Constructor: ServiceError(std::string_view message, std::optional<int> code = {}, std::map<std::string, std::string> context = {})
   - Methods: code() const, context() const, what() const override

2. TransportError (inherits ServiceError):
   - For transport-layer failures (connection lost, timeout)
   - Additional context: transport_type_

3. ProtocolError (inherits ServiceError):
   - For protocol violations (invalid JSON, unexpected message type)
   - Additional context: protocol_version_

4. RequestError (inherits ServiceError):
   - For request-specific errors (invalid params, method not found)
   - Additional context: method_, request_id_

5. Include <stdexcept>, <string>, <optional>, <map>

6. Namespace: mcpp::util

Follow rust-sdk error pattern from crates/rmcp/src/error.rs.
  </action>
  <verify>
grep -q "class ServiceError" src/mcpp/util/error.h && \
grep -q "class TransportError" src/mcpp/util/error.h && \
grep -q "class ProtocolError" src/mcpp/util/error.h && \
grep -q "class RequestError" src/mcpp/util/error.h && \
grep -q "std::runtime_error" src/mcpp/util/error.h
  </verify>
  <done>
Error hierarchy provides:
- ServiceError base with message, code, and context
- Specialized error types for each layer
- Context preservation for debugging
- std::exception compatible for catch blocks
  </done>
</task>

</tasks>

<verification>
1. list_all compiles with lambda returning PaginatedResult
2. Error types can be caught as std::exception
3. ServiceError preserves context through error chain
4. All error types properly inherit what() from std::runtime_error
</verification>

<success_criteria>
1. list_all eliminates manual cursor pagination boilerplate
2. ServiceError hierarchy enables structured error handling
3. Each error type carries relevant context for debugging
4. Errors are std::exception compatible for catch blocks
</success_criteria>

<output>
After completion, create `.planning/phases/06-high-level-api/06-04-SUMMARY.md` with:
- Tech stack added: Pagination helpers, error hierarchy
- Patterns established: Result-based error handling
- Key files: src/mcpp/util/pagination.h, src/mcpp/util/error.h
</output>
