---
phase: 04-advanced-features--http-transport
plan: 05
type: execute
wave: 3
depends_on: [04-03, 04-04]
files_modified: [src/mcpp/server/prompt_registry.h, src/mcpp/server/prompt_registry.cpp, src/mcpp/server/mcp_server.h, src/mcpp/server/mcp_server.cpp]
autonomous: true

must_haves:
  truths:
    - "Prompts can declare completion handler for argument autocompletion"
    - "Resources can declare completion handler for URI/value completion"
    - "McpServer routes completion requests to appropriate registry"
    - "Completion returns suggestions with values and optional descriptions"
  artifacts:
    - path: "src/mcpp/server/prompt_registry.h"
      provides: "Prompt completion support"
      min_lines: 100
      exports: ["Completion", "CompletionHandler", "set_completion_handler"]
    - path: "src/mcpp/server/resource_registry.h"
      provides: "Resource completion support"
      min_lines: 140
      exports: ["set_completion_handler"]
    - path: "src/mcpp/server/mcp_server.h"
      provides: "completion request routing"
      min_lines: 320
      exports: ["handle_completion", "handle_prompts_complete", "handle_resources_complete"]
  key_links:
    - from: "prompt_registry.h"
      to: "completion (MCP spec)"
      via: "Completion struct matches MCP CompleteResult format"
      pattern: "struct Completion"
    - from: "mcp_server.cpp"
      to: "prompt_registry.h, resource_registry.h"
      via: "delegate completion requests to registries"
      pattern: "prompts_.set_completion_handler|resources_.set_completion_handler"
    - from: "McpServer (02-05)"
      to: "mcp_server.h"
      via: "handle_request routes completion method"
      pattern: "completion/list"
---

<objective>
Argument completion for prompts and resources: completion handlers provide suggestions for argument values based on partial input and reference context.

Purpose: Completion enables IDE-like autocompletion for prompt arguments and resource values. Handlers receive the argument name, current value, and optional reference context to return relevant suggestions. This improves UX by reducing typos and discovering valid values.

Output: Completion support in PromptRegistry and ResourceRegistry with MCP completion/list request routing in McpServer.
</object>

<execution_context>
@/home/kotdath/.claude/get-shit-done/workflows/execute-plan.md
@/home/kotdath/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-advanced-features--http-transport/04-RESEARCH.md

# Existing prompt and resource registries to extend
@src/mcpp/server/prompt_registry.h
@src/mcpp/server/resource_registry.h
@src/mcpp/server/mcp_server.h
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Completion types and prompt completion support</name>
  <files>src/mcpp/server/prompt_registry.h</files>
  <action>
Add completion types and prompt completion handlers:

1. Define Completion struct (before PromptRegistry):
   ```cpp
   struct Completion {
       std::string value;           // The completion value
       std::optional<std::string> description;  // Optional description
   };
   ```

2. Define CompletionHandler type:
   ```cpp
   using CompletionHandler = std::function<std::vector<Completion>(
       const std::string& argument_name,
       const nlohmann::json& current_value,
       const std::optional<nlohmann::json>& reference
   )>;
   ```

3. Add completion handler storage to PromptRegistry:
   ```cpp
   // In PromptRegistry class
   std::unordered_map<std::string, CompletionHandler> completion_handlers_;
   ```

4. Add set_completion_handler method to PromptRegistry:
   ```cpp
   void set_completion_handler(
       const std::string& prompt_name,
       CompletionHandler handler
   );
   ```

5. Add get_completion method to PromptRegistry:
   ```cpp
   std::optional<std::vector<Completion>> get_completion(
       const std::string& prompt_name,
       const std::string& argument_name,
       const nlohmann::json& current_value,
       const std::optional<nlohmann::json>& reference
   ) const;
   ```

6. Include MIT license header

7. Include nlohmann/json.hpp for JSON types

Follow MCP completion spec: completion/list request takes name, argument, value, and optional reference. Returns CompleteResult with completion values.
  </action>
  <verify>
grep -q "struct Completion\|CompletionHandler" src/mcpp/server/prompt_registry.h && grep -q "set_completion_handler" src/mcpp/server/prompt_registry.h
  </verify>
  <done>
Completion struct defined with value and optional description. CompletionHandler type takes argument name, current value, and reference. PromptRegistry stores and invokes completion handlers.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement prompt completion and add to resource registry</name>
  <files>src/mcpp/server/prompt_registry.cpp, src/mcpp/server/resource_registry.h</files>
  <action>
Implement prompt completion and add resource registry completion:

1. Create prompt_registry.cpp (if doesn't exist) or append:
   - Implement set_completion_handler: store handler in completion_handlers_
   - Implement get_completion:
     * Look up handler by prompt_name
     * Call handler with argument_name, current_value, reference
     * Return vector of Completion suggestions
     * Return nullopt if no handler registered

2. Add to resource_registry.h:
   - Include Completion type (or define if not shared)
   - Add CompletionHandler type (same signature as prompts)
   - Add completion handler storage:
     ```cpp
     std::unordered_map<std::string, CompletionHandler> completion_handlers_;
     ```
   - Add set_completion_handler method (same signature as prompts)
   - Add get_completion method (same signature as prompts)

3. Update prompt_registry.h to include optional <vector> for get_completion return type

Note: Completion struct can be shared between registries. Consider moving to a common header if both use it.
  </action>
  <verify>
grep -q "get_completion" src/mcpp/server/prompt_registry.cpp && grep -q "set_completion_handler" src/mcpp/server/resource_registry.h
  </verify>
  <done>
PromptRegistry implements completion handler lookup and invocation. ResourceRegistry has completion support with same API.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add completion request routing to McpServer</name>
  <files>src/mcpp/server/mcp_server.h, src/mcpp/server/mcp_server.cpp</files>
  <action>
Add MCP completion/list request routing:

1. Update mcp_server.h:
   - Add completion methods declaration:
     ```cpp
     nlohmann::json handle_prompts_complete(const nlohmann::json& params);
     nlohmann::json handle_resources_complete(const nlohmann::json& params);
     ```
   - Add "completion" capability hint in ServerCapabilities (if needed)

2. Update handle_request in mcp_server.cpp:
   - Add case for "prompts/complete":
     ```cpp
     if (method == "prompts/complete") {
         return handle_prompts_complete(params);
     }
     ```
   - Add case for "resources/complete":
     ```cpp
     if (method == "resources/complete") {
         return handle_resources_complete(params);
     }
     ```

3. Implement handle_prompts_complete:
   - Extract name, argument, value, reference from params
   - Call prompts_.get_completion(name, argument, value, reference)
   - Return MCP CompleteResult format:
     ```cpp
     {
         {"completion", {
             {{"value", completion.value}},
             {{"description", completion.description}}  // if present
         }}
     }
     ```
   - Return empty array if no handler registered

4. Implement handle_resources_complete:
   - Same pattern as prompts_complete
   - Call resources_.get_completion instead
   - Return same CompleteResult format

5. Handle missing arguments gracefully:
   - Return JSON-RPC INVALID_PARAMS error if name or argument missing
   - Use existing error response pattern from other handlers

Follow MCP completion spec: prompts/complete and resources/complete take name, argument, value, and optional reference.
  </action>
  <verify>
grep -q "handle_prompts_complete\|handle_resources_complete" src/mcpp/server/mcp_server.h && grep -q "prompts/complete\|resources/complete" src/mcpp/server/mcp_server.cpp
  </verify>
  <done>
McpServer routes prompts/complete and resources/complete requests. Handlers return completion suggestions with values and descriptions. Missing params return INVALID_PARAMS error.
  </done>
</task>

</tasks>

<verification>
After completion:
1. Prompts can have completion handlers for specific arguments
2. Resources can have completion handlers
3. McpServer routes completion requests to appropriate registry
4. Completion responses match MCP CompleteResult format
5. Empty completion list returned when no handler registered
</verification>

<success_criteria>
1. Completion struct with value and optional description
2. CompletionHandler type matches MCP completion/list signature
3. Both PromptRegistry and ResourceRegistry support completion
4. McpServer routes prompts/complete and resources/complete
5. Graceful handling of missing handlers and invalid params
</success_criteria>

<output>
After completion, create `.planning/phases/04-advanced-features--http-transport/04-05-SUMMARY.md`
</output>
