---
phase: 04-advanced-features--http-transport
plan: 06
type: execute
wave: 3
depends_on: [04-01]
files_modified: [src/mcpp/server/request_context.h, src/mcpp/server/request_context.cpp]
autonomous: true

must_haves:
  truths:
    - "Tool handlers can send incremental results via RequestContext"
    - "Streaming results are formatted as SSE events or progress notifications"
    - "RequestContext supports both progress and streaming modes"
    - "SseFormatter is used for HTTP transport streaming"
  artifacts:
    - path: "src/mcpp/server/request_context.h"
      provides: "Tool result streaming support"
      min_lines: 100
      exports: ["send_stream_result", "is_streaming"]
    - path: "src/mcpp/server/request_context.cpp"
      provides: "Streaming implementation"
      min_lines: 80
      contains: "progress notification, SSE formatting"
  key_links:
    - from: "request_context.h"
      to: "sse_formatter.h (04-01)"
      via: "static method call for SSE formatting"
      pattern: "SseFormatter::format_event"
    - from: "ToolRegistry (04-03)"
      to: "request_context.h"
      via: "send_stream_result for incremental results"
      pattern: "send_stream_result"
    - from: "RequestContext (02-04)"
      to: "request_context.h"
      via: "extending existing progress support"
      pattern: "report_progress"
---

<objective>
Tool result streaming via RequestContext: incremental results for long-running operations.

Purpose: Some tools generate results over time (e.g., file processing, LLM generation). Streaming enables incremental result delivery instead of waiting for completion. Uses existing progress notification mechanism with streaming-specific formatting.

Output: Extended RequestContext with send_stream_result method for incremental tool results.
</objective>

<execution_context>
@/home/kotdath/.claude/get-shit-done/workflows/execute-plan.md
@/home/kotdath/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-advanced-features--http-transport/04-RESEARCH.md
@.planning/phases/04-advanced-features--http-transport/04-01-PLAN.md

# Existing RequestContext to extend
@src/mcpp/server/request_context.h

# SSE formatter from plan 04-01
@src/mcpp/util/sse_formatter.h
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add streaming support to RequestContext header</name>
  <files>src/mcpp/server/request_context.h</files>
  <action>
Extend RequestContext with streaming capability:

1. Include util/sse_formatter.h for SSE formatting

2. Add streaming mode flag:
   ```cpp
   // In RequestContext class
   bool streaming_ = false;
   ```

3. Add is_streaming method:
   ```cpp
   bool is_streaming() const;
   ```

4. Add set_streaming method:
   ```cpp
   void set_streaming(bool enable);
   ```

5. Add send_stream_result method:
   ```cpp
   void send_stream_result(const nlohmann::json& partial_result);
   ```

6. Update documentation comment for RequestContext:
   - Mention streaming support for incremental results
   - Document that send_stream_result sends partial results
   - Note: Final result marks completion (no explicit "done" message needed)

7. Keep existing report_progress method for progress notifications

Streaming format: send_stream_result sends the partial result as-is. For HTTP/SSE transport, the result is wrapped in SSE format. For stdio transport, it's sent as a regular JSON-RPC notification.

Include MIT license header.
  </action>
  <verify>
grep -q "send_stream_result\|is_streaming" src/mcpp/server/request_context.h
  </verify>
  <done>
RequestContext has send_stream_result method and streaming mode flag. is_streaming() returns current mode.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement streaming with SSE formatting</name>
  <files>src/mcpp/server/request_context.cpp</files>
  <action>
Implement streaming result delivery:

1. Implement is_streaming:
   ```cpp
   bool RequestContext::is_streaming() const {
       return streaming_;
   }
   ```

2. Implement set_streaming:
   ```cpp
   void RequestContext::set_streaming(bool enable) {
       streaming_ = enable;
   }
   ```

3. Implement send_stream_result:
   - Format partial_result as JSON
   - For HTTP/SSE transport: use SseFormatter::format_event
   - For stdio transport: send as regular JSON message
   - Send via transport_.send()
   ```cpp
   void RequestContext::send_stream_result(const nlohmann::json& partial_result) {
       std::string message = partial_result.dump();

       // If HTTP transport, wrap in SSE format
       // Detect transport type or use flag (for now, always wrap in SSE-compatible format)
       std::string sse_message = SseFormatter::format_event(partial_result, request_id_);
       transport_.send(sse_message);
   }
   ```

4. Handle no-progress-token case gracefully:
   - If no progress token, send_stream_result is a no-op
   - Check has_progress_token() before sending

5. Update report_progress to also check streaming mode:
   - Progress notifications work regardless of streaming mode
   - Both can be used together (progress + incremental results)

Note: SSE formatting ensures compatibility with HTTP transport. For stdio, the format is still valid JSON-RPC.
  </action>
  <verify>
grep -q "send_stream_result\|SseFormatter::format_event" src/mcpp/server/request_context.cpp
  </verify>
  <done>
send_stream_result formats results via SseFormatter. Progress token checked before sending. Works with both HTTP/SSE and stdio transports.
  </done>
</task>

</tasks>

<verification>
After completion:
1. Tool handlers can call ctx.send_stream_result() for incremental results
2. Streaming results formatted via SseFormatter
3. No-op when no progress token available
4. Existing report_progress still works
5. Both stdio and HTTP transports supported
</verification>

<success_criteria>
1. send_stream_result method sends incremental results
2. SSE formatting via SseFormatter for HTTP transport
3. Graceful no-op when no progress token
4. Streaming mode flag accessible via is_streaming()
5. Compatible with existing progress reporting
</success_criteria>

<output>
After completion, create `.planning/phases/04-advanced-features--http-transport/04-06-SUMMARY.md`
</output>
