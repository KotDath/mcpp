---
phase: 08-bug-fix-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/mcpp/core/json_rpc.h
  - src/mcpp/core/json_rpc.cpp
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Library provides JsonRpcRequest::from_json() for proper request validation"
    - "Malformed JSON-RPC requests return nullopt (no exceptions thrown)"
    - "Validation errors provide detailed diagnostics via ParseError struct"
    - "ParseError includes extracted request ID for error responses"
  artifacts:
    - path: "src/mcpp/core/json_rpc.h"
      provides: "JsonRpcRequest::from_json() declaration, ParseError struct"
      contains: "static std::optional<JsonRpcRequest> from_json"
      min_lines: 100
    - path: "src/mcpp/core/json_rpc.cpp"
      provides: "JsonRpcRequest::from_json() implementation, ParseError factory methods"
      contains: "std::optional<JsonRpcRequest> JsonRpcRequest::from_json"
      min_lines: 200
  key_links:
    - from: "JsonRpcRequest::from_json()"
      to: "detail::parse_request_id()"
      via: "reuse existing RequestId parsing helper"
      pattern: "detail::parse_request_id"
    - from: "ParseError::id"
      to: "JsonRpcRequest::id"
      via: "extract ID from malformed JSON for error responses"
      pattern: "std::optional<RequestId> id"
---

<objective>
Implement JsonRpcRequest::from_json() validation with ParseError diagnostics

Purpose: Phase 9 example server needs proper request validation to detect malformed JSON-RPC requests and return appropriate parse error responses. Current library has JsonRpcResponse::from_json() but missing the request-side equivalent.

Output: JsonRpcRequest::from_json() static method that validates JSON-RPC 2.0 request structure and returns std::optional<JsonRpcRequest>, plus ParseError struct for detailed diagnostics when validation fails.
</objective>

<execution_context>
@/home/kotdath/.claude/get-shit-done/workflows/execute-plan.md
@/home/kotdath/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-bug-fix-foundation/08-CONTEXT.md
@.planning/phases/08-bug-fix-foundation/08-RESEARCH.md
@src/mcpp/core/json_rpc.h
@src/mcpp/core/json_rpc.cpp
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add ParseError struct to JsonRpcRequest</name>
  <files>src/mcpp/core/json_rpc.h</files>
  <action>
    Add ParseError as a nested struct within JsonRpcRequest (forward-declared before JsonRpcRequest definition):

    ```cpp
    struct JsonRpcRequest {
        // ParseError diagnostics struct
        struct ParseError {
            enum class Code {
                MissingJsonrpc,
                InvalidJsonrpcVersion,
                MissingId,
                InvalidIdType,
                MissingMethod,
                InvalidMethodType,
                InvalidParamsType,
                MalformedJson
            };

            Code code;
            std::string message;  // Human-readable, NO raw JSON content (security)
            std::optional<RequestId> id;  // Extracted if available for error response

            // Factory methods for common errors
            static ParseError missing_jsonrpc() {
                return {Code::MissingJsonrpc, "Missing required 'jsonrpc' field", std::nullopt};
            }
            static ParseError invalid_jsonrpc_version() {
                return {Code::InvalidJsonrpcVersion, "Invalid 'jsonrpc' version (must be '2.0')", std::nullopt};
            }
            static ParseError missing_id() {
                return {Code::MissingId, "Missing required 'id' field", std::nullopt};
            }
            static ParseError invalid_id_type() {
                return {Code::InvalidIdType, "Invalid 'id' type (must be string, number, or null)", std::nullopt};
            }
            static ParseError missing_method() {
                return {Code::MissingMethod, "Missing required 'method' field", std::nullopt};
            }
            static ParseError invalid_method_type() {
                return {Code::InvalidMethodType, "Invalid 'method' type (must be string)", std::nullopt};
            }
            static ParseError invalid_params_type() {
                return {Code::InvalidParamsType, "Invalid 'params' type (must be object or array)", std::nullopt};
            }
            static ParseError malformed_json() {
                return {Code::MalformedJson, "Malformed JSON", std::nullopt};
            }
        };

        // ... existing JsonRpcRequest fields ...
    ```

    IMPORTANT: Do NOT include raw JSON content in error messages (security - avoid echoing malicious input).
  </action>
  <verify>grep -q "struct ParseError" src/mcpp/core/json_rpc.h && grep -q "enum class Code" src/mcpp/core/json_rpc.h</verify>
  <done>ParseError struct declared with Code enum, message, id field, and factory methods</done>
</task>

<task type="auto">
  <name>Task 2: Add from_json() declaration to JsonRpcRequest</name>
  <files>src/mcpp/core/json_rpc.h</files>
  <action>
    Add static from_json() method declaration to JsonRpcRequest struct (after to_string() method, before closing brace):

    ```cpp
    /**
     * Parse a JSON value into a JsonRpcRequest
     *
     * Validates JSON-RPC 2.0 request structure including:
     * - jsonrpc field equals "2.0"
     * - id field is present and valid (string, number, or null)
     * - method field is present and is a string
     * - params field (if present) is object or array
     *
     * @param j JSON value to parse
     * @return Parsed request, or nullopt if parsing fails
     */
    static std::optional<JsonRpcRequest> from_json(const JsonValue& j);
    ```

    This mirrors the existing JsonRpcResponse::from_json() pattern at line 115.
  </action>
  <verify>grep -q "static std::optional<JsonRpcRequest> from_json" src/mcpp/core/json_rpc.h</verify>
  <done>from_json() declaration added to JsonRpcRequest struct</done>
</task>

<task type="auto">
  <name>Task 3: Implement from_json() in json_rpc.cpp</name>
  <files>src/mcpp/core/json_rpc.cpp</files>
  <action>
    Add implementation after detail::parse_request_id() function (before JsonRpcResponse::from_json()):

    ```cpp
    // JsonRpcRequest implementation

    std::optional<JsonRpcRequest> JsonRpcRequest::from_json(const JsonValue& j) {
        try {
            // Check for jsonrpc field
            if (!j.contains("jsonrpc") || !j["jsonrpc"].is_string()) {
                return std::nullopt;
            }
            std::string jsonrpc_version = j["jsonrpc"].get<std::string>();
            if (jsonrpc_version != "2.0") {
                return std::nullopt;
            }

            // Check for id field (required for requests)
            if (!j.contains("id")) {
                return std::nullopt;
            }
            auto id_opt = detail::parse_request_id(j["id"]);
            if (!id_opt) {
                return std::nullopt;
            }

            // Check for method field
            if (!j.contains("method") || !j["method"].is_string()) {
                return std::nullopt;
            }

            JsonRpcRequest request;
            request.jsonrpc = jsonrpc_version;
            request.id = *id_opt;
            request.method = j["method"].get<std::string>();

            // Check for params (optional, but must be object or array if present)
            if (j.contains("params")) {
                const JsonValue& params = j["params"];
                if (!params.is_object() && !params.is_array()) {
                    return std::nullopt;
                }
                request.params = params;
            }

            return request;

        } catch (const nlohmann::json::exception&) {
            return std::nullopt;
        } catch (const std::exception&) {
            return std::nullopt;
        }
    }
    ```

    Follow the exact pattern of JsonRpcResponse::from_json() (lines 53-115):
    - Return std::nullopt on validation failure
    - Catch nlohmann::json::exception and std::exception
    - Reuse detail::parse_request_id() helper for ID parsing
  </action>
  <verify>grep -A 50 "std::optional<JsonRpcRequest> JsonRpcRequest::from_json" src/mcpp/core/json_rpc.cpp | head -60</verify>
  <done>from_json() validates jsonrpc==2.0, id present, method present and string, params is object/array if present</done>
</task>

</tasks>

<verification>
1. Build passes: cmake --build build
2. Unit tests pass: ctest --test-dir build
3. from_json() accepts valid JSON-RPC 2.0 requests
4. from_json() returns nullopt for malformed requests (missing jsonrpc, wrong version, missing id, missing method, invalid params type)
5. No exceptions thrown for malformed input (all caught, return nullopt)
</verification>

<success_criteria>
1. JsonRpcRequest::from_json() validates JSON-RPC 2.0 request structure
2. Malformed requests return std::nullopt without throwing exceptions
3. ParseError struct provides detailed error codes for debugging
4. Implementation mirrors existing JsonRpcResponse::from_json() pattern
</success_criteria>

<output>
After completion, create `.planning/phases/08-bug-fix-foundation/08-01-SUMMARY.md`
</output>
