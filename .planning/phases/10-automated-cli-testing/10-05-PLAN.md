---
phase: 10-automated-cli-testing
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - .github/workflows/test.yml
  - tests/CMakeLists.txt
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "CI/CD pipeline runs on push and pull request to main branch"
    - "CLI tests execute in CI environment via ctest"
    - "bats executable is discoverable by CMake in CI environment"
    - "All CLI tests pass in CI (unit + integration + compliance + cli)"
  artifacts:
    - path: ".github/workflows/test.yml"
      provides: "GitHub Actions CI configuration"
      contains: "on: push, jobs: test, steps: checkout, setup, build, test"
    - path: "tests/CMakeLists.txt"
      provides: "CMake configuration that finds bats in Git submodule"
      contains: "find_program(BATS_PROGRAM)"
  key_links:
    - from: ".github/workflows/test.yml"
      to: "tests/CMakeLists.txt"
      via: "PATH environment variable includes tests/cli/bats/bin"
      pattern: "PATH.*tests/cli/bats/bin"
---
<objective>
Create GitHub Actions CI/CD pipeline that runs all tests including CLI tests via CMake/CTest

**Purpose:** Close the critical CI/CD integration gap (Gap 1 from VERIFICATION.md) that prevents automated test execution in continuous integration pipelines. The phase goal includes "CI/CD runs cli-tests target as part of test suite" but no CI/CD configuration exists.

**Output:** Working GitHub Actions workflow that:
1. Checks out code including Git submodules (bats-core)
2. Sets up build environment (CMake, gcc, dependencies)
3. Configures CMake with bats discoverable in PATH
4. Builds library and examples
5. Runs all tests via ctest (unit, integration, compliance, CLI)

**Gap being closed:** Gap 1 - CI/CD Integration Missing
- Missing: .github/workflows/test.yml or similar CI configuration
- Missing: CMake configuration to find bats in tests/cli/bats/bin/bats (or bats in PATH)
- Impact: CLI tests must be run manually; automated CI/CD pipelines cannot execute them
</objective>

<execution_context>
@/home/kotdath/.claude/get-shit-done/workflows/execute-plan.md
@/home/kotdath/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/10-automated-cli-testing/10-VERIFICATION.md
@.planning/phases/10-automated-cli-testing/10-04-SUMMARY.md
@.planning/ROADMAP.md

# Gap Context from 10-VERIFICATION.md

**Gap 1: CI/CD Integration Missing (Critical)**

The phase goal includes "CI/CD runs cli-tests target as part of test suite" but:
1. No CI/CD configuration exists (`.github/workflows/` directory missing)
2. CMake cannot find `bats` executable during configuration (BATS_PROGRAM-NOTFOUND)
3. CLI tests are not registered with CTest because the `if(BATS_PROGRAM AND JQ_PROGRAM)` block evaluates to false

**Required fixes:**
1. Create `.github/workflows/test.yml` or similar CI configuration
2. Either:
   - Add bats to system PATH in CI environment, OR
   - Modify CMakeLists.txt to check `tests/cli/bats/bin/bats` directly, OR
   - Add instruction to symlink/install bats before running CMake

**Decision for this plan:** Use approach #1 (add bats to PATH in CI) because:
- Minimal changes to existing CMakeLists.txt
- Works consistently across local dev and CI environments
- Follows established pattern from 10-04-SUMMARY.md which documents PATH setup

# Existing Work from 10-04-SUMMARY.md

From 10-04-SUMMARY.md:
- tests/CMakeLists.txt lines 111-199 configure CLI tests with find_program(BATS_PROGRAM)
- User setup note: "For CMake/CTest to discover CLI tests, `bats` must be in PATH. The Git submodule at `tests/cli/bats/bin/bats` can be used"
- Tests run successfully with: `export PATH="$PWD/tests/cli/bats/bin:$PATH"`
- All 45 CLI tests passing (40 existing + 5 lifecycle tests)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GitHub Actions workflow configuration</name>
  <files>.github/workflows/test.yml</files>
  <action>
Create .github/workflows/test.yml with GitHub Actions configuration:

**Directory creation:**
- Create .github/workflows/ directory if it doesn't exist

**Workflow structure:**
```yaml
name: Tests

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive  # Critical: fetches bats-core and helper libraries

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake g++ libssl-dev jq nlohmann-json3-dev

    - name: Configure CMake
      run: |
        export PATH="${PWD}/tests/cli/bats/bin:${PATH}"
        cmake -B build -DCMAKE_BUILD_TYPE=Debug

    - name: Build
      run: cmake --build build

    - name: Run tests
      run: |
        export PATH="${PWD}/tests/cli/bats/bin:${PATH}"
        cd build && ctest --output-on-failure
```

**Critical elements:**
- `submodules: recursive` ensures Git submodules (bats-core, bats-*) are checked out
- `export PATH` includes tests/cli/bats/bin so CMake's find_program(BATS_PROGRAM) succeeds
- jq installed via apt-get for JSON validation in tests
- nlohmann-json3-dev installed for JSON library dependency
- `ctest --output-on-failure` shows test output on failure

**Do NOT:**
- Use matrix builds (keep it simple - single Ubuntu job)
- Add macOS/Windows runners (out of scope for gap closure)
- Cache build artifacts (unnecessary complexity for this project size)
- Add deployment steps (out of scope for testing workflow)
  </action>
  <verify>
1. File exists at .github/workflows/test.yml
2. Valid YAML syntax: `python3 -c "import yaml; yaml.safe_load(open('.github/workflows/test.yml'))"`
3. Contains required keys: name, on, jobs, test, steps
4. Contains submodules: recursive
5. Contains PATH export with tests/cli/bats/bin
  </verify>
  <done>
GitHub Actions workflow file created with valid YAML that:
- Triggers on push/PR to main branch
- Checks out Git submodules recursively
- Installs dependencies (cmake, g++, libssl-dev, jq, nlohmann-json3-dev)
- Adds tests/cli/bats/bin to PATH before CMake configuration
- Builds and runs all tests via ctest
  </done>
</task>

<task type="auto">
  <name>Task 2: Update CMakeLists.txt to find bats in Git submodule</name>
  <files>tests/CMakeLists.txt</files>
  <action>
Update tests/CMakeLists.txt to help CMake find bats in the Git submodule location:

**Current state (lines 110-112):**
```cmake
# Find bats and jq for CLI tests
find_program(BATS_PROGRAM bats)
find_program(JQ_PROGRAM jq)
```

**Change to:**
```cmake
# Find bats and jq for CLI tests
# bats is in Git submodule at tests/cli/bats/bin/bats
# Add submodule location to search path for better discoverability
set(BATS_POSSIBLE_PATHS
    "${CMAKE_CURRENT_SOURCE_DIR}/cli/bats/bin/bats"
    "${CMAKE_CURRENT_SOURCE_DIR}/cli/bats/bin"
    "$ENV{BATS_BIN_DIR}"
    "$ENV{PATH}"
)

find_program(BATS_PROGRAM bats
    HINTS ${BATS_POSSIBLE_PATHS}
    PATHS ${BATS_POSSIBLE_PATHS}
)

find_program(JQ_PROGRAM jq)
```

**Why this change:**
- HINTS tells CMake to check the Git submodule location first
- Falls back to system PATH if not found in submodule
- Works both in CI (explicit PATH set) and local dev (submodule available)
- No breaking changes to existing behavior

**Location:** After line 109 (the comment block), before the if(BATS_PROGRAM AND JQ_PROGRAM) block

**Do NOT:**
- Remove the conditional if(BATS_PROGRAM AND JQ_PROGRAM) block
- Change test registration logic
- Modify existing add_test() calls
  </action>
  <verify>
1. tests/CMakeLists.txt modified with new find_program(BATS_PROGRAM) call
2. Contains HINTS with ${CMAKE_CURRENT_SOURCE_DIR}/cli/bats/bin/bats
3. CMake configures successfully: `cmake -B build -DCMAKE_BUILD_TYPE=Debug`
4. BATS_PROGRAM found (not BATS_PROGRAM-NOTFOUND): `grep BATS_PROGRAM build/CMakeCache.txt`
5. ctest lists CLI tests: `ctest -N -R cli`
  </verify>
  <done>
CMakeLists.txt updated so that:
- CMake searches for bats in Git submodule location first
- find_program uses HINTS to prioritize tests/cli/bats/bin/bats
- Falls back to system PATH if not found in submodule
- Works in both CI (explicit PATH) and local dev (submodule discovery)
- No changes to conditional test registration or existing test targets
  </done>
</task>

</tasks>

<verification>
**Overall phase checks:**

1. **CI/CD workflow syntax:**
   ```bash
   # Validate YAML syntax
   python3 -c "import yaml; yaml.safe_load(open('.github/workflows/test.yml'))"
   ```
   Expected: No syntax errors

2. **CMake discovers bats in submodule:**
   ```bash
   rm -rf build && cmake -B build -DCMAKE_BUILD_TYPE=Debug
   grep "BATS_PROGRAM.*NOTFOUND" build/CMakeCache.txt
   ```
   Expected: No matches (bats found successfully)

3. **CLI tests registered with CTest:**
   ```bash
   ctest -N -R cli | grep -E "cli-tests|cli-initialize|cli-tools"
   ```
   Expected: At least 7 CLI tests listed (cli-tests + 6 individual test files)

4. **Full test suite passes:**
   ```bash
   cmake --build build && cd build && ctest --output-on-failure
   ```
   Expected: All tests pass (unit + integration + compliance + cli)

**Gap closure verification:**
- [ ] CI/CD configuration exists (.github/workflows/test.yml created)
- [ ] bats discoverable by CMake (BATS_PROGRAM found, not NOTFOUND)
- [ ] CLI tests registered with CTest (ctest -N shows cli-* tests)
- [ ] All tests can run via ctest (unit + integration + compliance + cli)
</verification>

<success_criteria>
**Measurable completion:**

1. `.github/workflows/test.yml` exists with valid YAML
2. CMake finds bats executable (BATS_PROGRAM-NOTFOUND not in CMakeCache.txt)
3. `ctest -N` lists at least 7 CLI tests (cli-tests + cli-initialize + cli-tools-list + cli-tools-call + cli-resources + cli-prompts + cli-lifecycle)
4. `ctest --output-on-failure` runs and passes all tests locally
5. GitHub Actions workflow would run successfully (validated by workflow syntax and local ctest execution)

**Observable behavior:**
- User can push to GitHub and CI automatically runs all tests
- CLI tests execute in CI environment via bats from Git submodule
- No manual PATH setup required in CI (handled by workflow)
- Local dev works with or without bats in system PATH (CMake finds submodule)
</success_criteria>

<output>
After completion, create `.planning/phases/10-automated-cli-testing/10-05-SUMMARY.md` documenting:
- CI/CD workflow created
- CMakeLists.txt updated for better bats discovery
- All tests pass via ctest
- Gap 1 (CI/CD Integration Missing) closed
</output>
