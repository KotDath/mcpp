---
phase: 10-automated-cli-testing
plan: 04
type: execute
wave: 3
depends_on: ["10-02", "10-03"]
files_modified:
  - tests/cli/06-lifecycle.bats
  - tests/CMakeLists.txt
autonomous: true

must_haves:
  truths:
    - "Server lifecycle tests verify startup and shutdown"
    - "Background processes are cleaned up using trap EXIT"
    - "No process leaks after test execution"
    - "CMake cli-tests target runs all bats tests"
    - "CTest discovers and can execute cli-tests"
  artifacts:
    - path: "tests/cli/06-lifecycle.bats"
      provides: "Server lifecycle and process cleanup tests"
      contains: "trap.*EXIT"
      min_lines: 30
    - path: "tests/CMakeLists.txt"
      provides: "CMake integration for CLI tests"
      contains: "find_program.*BATS"
  key_links:
    - from: "tests/cli/06-lifecycle.bats"
      to: "examples/inspector_server"
      via: "background process with &"
    - from: "tests/cli/06-lifecycle.bats"
      to: "trap"
      via: "cleanup function for process management"
    - from: "tests/CMakeLists.txt"
      to: "tests/cli"
      via: "add_test(NAME cli-tests COMMAND \${BATS_PROGRAM} ...)"
    - from: "tests/CMakeLists.txt"
      to: "build/examples"
      via: "PATH environment variable configuration"
---

<objective>
Create server lifecycle tests and integrate CLI tests with CMake build system.

Purpose: Validate that the inspector_server can be started, stopped, and cleaned up properly without leaving background processes. Additionally, integrate the bats test suite with CMake/CTest so that `make test` or `ctest` runs the CLI tests alongside existing unit and integration tests.

Output: tests/cli/06-lifecycle.bats and updated tests/CMakeLists.txt
</objective>

<execution_context>
@/home/kotdath/.claude/get-shit-done/workflows/execute-plan.md
@/home/kotdath/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-automated-cli-testing/10-RESEARCH.md
@.planning/phases/10-automated-cli-testing/10-02-SUMMARY.md
@.planning/phases/10-automated-cli-testing/10-03-SUMMARY.md
@tests/CMakeLists.txt

# Prior Context
Phase 10-02 created 05-initialize.bats and 01-tools-list.bats
Phase 10-03 created 02-tools-call.bats, 03-resources.bats, 04-prompts.bats
tests/CMakeLists.txt has existing GoogleTest integration with gtest_discover_tests
</context>

<tasks>

<task type="auto">
  <name>Create 06-lifecycle.bats for server lifecycle tests</name>
  <files>tests/cli/06-lifecycle.bats</files>
  <action>
    Create tests/cli/06-lifecycle.bats with the following tests:

    1. Test: "server starts without errors"
       - Start inspector_server in background: `inspector_server > "$BATS_TEST_TMPDIR/server.log" 2>&1 &`
       - Capture PID: `SERVER_PID=$!`
       - Verify server is running: `kill -0 $SERVER_PID`
       - Cleanup with trap: `trap "kill $SERVER_PID 2>/dev/null || true" EXIT`
       - Wait for server: `sleep 0.5`

    2. Test: "server responds to initialize after startup"
       - Start server with trap cleanup
       - Send initialize request via stdin
       - Verify valid response
       - Verify server log shows no errors

    3. Test: "server shuts down cleanly on EOF"
       - Start server with trap cleanup
       - Send initialize request
       - Close stdin (send EOF)
       - Verify server exits (wait for process)
       - Verify server log shows "Server shutting down"

    4. Test: "server cleanup on test failure"
       - Start server with trap cleanup
       - Kill test forcefully (simulating failure)
       - Verify trap runs and server is cleaned up
       - Verify no orphaned inspector_server processes

    5. Test: "multiple sequential server instances"
       - Start and stop server 3 times in sequence
       - Verify no conflicts or port binding issues
       - Verify clean shutdown each time

    Use RESEARCH.md Pattern 2 (Server Lifecycle Management):
    - Start server in background with `&`
    - Capture PID immediately
    - Use `trap "kill $SERVER_PID 2>/dev/null || true" EXIT`
    - Use `sleep 0.5` after startup for initialization
    - Redirect output to $BATS_TEST_TMPDIR/server.log for debugging

    Reference RESEARCH.md Pitfall 1 (Process Leaks) for cleanup patterns.
  </action>
  <verify>
    1. File exists with at least 4 @test blocks
    2. File uses trap for cleanup: `grep "trap.*EXIT" tests/cli/06-lifecycle.bats`
    3. File starts server in background: `grep "&" tests/cli/06-lifecycle.bats`
    4. File captures PID: `grep "SERVER_PID=" tests/cli/06-lifecycle.bats`
    5. File uses $BATS_TEST_TMPDIR for log files
  </verify>
  <done>
    - 06-lifecycle.bats created with 5 tests covering server lifecycle
    - All tests use trap for guaranteed cleanup
    - Process leak prevention verified
  </done>
</task>

<task type="auto">
  <name>Add CMake integration for CLI tests</name>
  <files>tests/CMakeLists.txt</files>
  <action>
    Update tests/CMakeLists.txt to add CLI test integration:

    1. After the existing GoogleTest setup, add bats and jq detection:
       ```cmake
       # Find bats and jq for CLI tests
       find_program(BATS_PROGRAM bats)
       find_program(JQ_PROGRAM jq)

       # Add CLI tests only if bats and jq are available
       if(BATS_PROGRAM AND JQ_PROGRAM)
           # Add a test that runs the entire bats suite
           add_test(
               NAME cli-tests
               COMMAND ${BATS_PROGRAM} ${CMAKE_CURRENT_SOURCE_DIR}/cli
               WORKING_DIRECTORY ${CMAKE_CURRENT_BINARY_DIR}
           )

           # Set test labels for CTest
           set_tests_properties(cli-tests PROPERTIES
               LABELS "cli;bats"
               ENVIRONMENT "PATH=${CMAKE_BINARY_DIR}/examples:$ENV{PATH}"
           )

           # Optional: Add individual test files as separate tests
           add_test(
               NAME cli-initialize
               COMMAND ${BATS_PROGRAM} ${CMAKE_CURRENT_SOURCE_DIR}/cli/05-initialize.bats
               WORKING_DIRECTORY ${CMAKE_CURRENT_BINARY_DIR}
           )
           set_tests_properties(cli-initialize PROPERTIES
               LABELS "cli;bats;initialize"
               ENVIRONMENT "PATH=${CMAKE_BINARY_DIR}/examples:$ENV{PATH}"
           )
       endif()
       ```

    2. Add a comment explaining that bats-core is a Git submodule:
       ```cmake
       # Note: bats-core is installed as a Git submodule in tests/cli/bats
       # Run: git submodule update --init --recursive
       # If bats is not found, CLI tests will be skipped
       ```

    3. DO NOT add system package dependencies (apt-get, brew) - document Git submodule requirement only

    4. DO NOT modify existing GoogleTest configuration (mcpp_unit_tests, mcpp_integration_tests, mcpp_compliance_tests)

    5. Set RUN_SERIAL property for cli-tests to avoid parallel execution issues:
       ```cmake
       set_tests_properties(cli-tests PROPERTIES
           LABELS "cli;bats"
           RUN_SERIAL TRUE
           ENVIRONMENT "PATH=${CMAKE_BINARY_DIR}/examples:$ENV{PATH}"
       )
       ```

    Reference RESEARCH.md Pattern 4 (CMake Integration).
  </action>
  <verify>
    1. tests/CMakeLists.txt contains find_program(BATS_PROGRAM)
    2. tests/CMakeLists.txt contains find_program(JQ_PROGRAM)
    3. tests/CMakeLists.txt contains add_test(NAME cli-tests ...)
    4. tests/CMakeLists.txt sets PATH environment variable to build/examples
    5. tests/CMakeLists.txt sets RUN_SERIAL TRUE for cli-tests
    6. Existing GoogleTest targets are unchanged
  </verify>
  <done>
    - CMakeLists.txt updated with bats and jq detection
    - cli-tests target added to CTest
    - PATH configured to find inspector_server in build directory
    - RUN_SERIAL set to avoid parallel execution issues
  </done>
</task>

</tasks>

<verification>
After completing this plan:
1. 06-lifecycle.bats exists with >= 4 tests
2. tests/CMakeLists.txt contains BATS_PROGRAM and JQ_PROGRAM detection
3. tests/CMakeLists.txt contains add_test(NAME cli-tests ...)
4. `cmake -B build && cmake --build build` completes without errors
5. `cd build && ctest -N | grep cli-tests` shows the test is registered
6. After running tests, `ps aux | grep inspector_server | grep -v grep` returns no results (no process leaks)
</verification>

<success_criteria>
1. Server lifecycle tests verify startup, shutdown, and cleanup
2. Background processes cleaned up using trap EXIT
3. No process leaks after test execution (verified with ps aux)
4. CMake `make test` or `ctest` runs CLI tests
5. CLI tests skipped if bats or jq not available (not fatal)
</success_criteria>

<output>
After completion, create `.planning/phases/10-automated-cli-testing/10-04-SUMMARY.md`
</output>
