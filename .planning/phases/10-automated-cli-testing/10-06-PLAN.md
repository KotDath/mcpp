---
phase: 10-automated-cli-testing
plan: 06
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/cli/02-tools-call.bats
  - tests/cli/03-resources.bats
  - tests/cli/04-prompts.bats
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "All test files use common-setup.bash helper consistently"
    - "No duplicated helper loading code across test files"
    - "Changes to setup logic only require updating one file"
    - "All tests still pass after refactoring"
  artifacts:
    - path: "tests/cli/02-tools-call.bats"
      provides: "Tools/call endpoint tests"
      contains: "load 'test_helper/common-setup'"
    - path: "tests/cli/03-resources.bats"
      provides: "Resources endpoint tests"
      contains: "load 'test_helper/common-setup'"
    - path: "tests/cli/04-prompts.bats"
      provides: "Prompts endpoint tests"
      contains: "load 'test_helper/common-setup'"
  key_links:
    - from: "tests/cli/02-tools-call.bats"
      to: "tests/cli/test_helper/common-setup.bash"
      via: "load 'test_helper/common-setup'"
      pattern: "load 'test_helper/common-setup'"
    - from: "tests/cli/03-resources.bats"
      to: "tests/cli/test_helper/common-setup.bash"
      via: "load 'test_helper/common-setup'"
      pattern: "load 'test_helper/common-setup'"
    - from: "tests/cli/04-prompts.bats"
      to: "tests/cli/test_helper/common-setup.bash"
      via: "load 'test_helper/common-setup'"
      pattern: "load 'test_helper/common-setup'"
---
<objective>
Refactor test files to use common-setup.bash helper consistently, eliminating code duplication

**Purpose:** Close the minor code quality gap (Gap 2 from VERIFICATION.md) where files 02-tools-call.bats, 03-resources.bats, and 04-prompts.bats use direct helper loading instead of the common-setup.bash helper. This results in ~30 lines of duplicated code across 3 files.

**Output:** All 6 test files use consistent setup pattern:
- 01-tools-list.bats (already uses common-setup)
- 02-tools-call.bats (refactored)
- 03-resources.bats (refactored)
- 04-prompts.bats (refactored)
- 05-initialize.bats (already uses common-setup)
- 06-lifecycle.bats (already uses common-setup)

**Gap being closed:** Gap 2 - Inconsistent common-setup Usage
- Missing: Consistent use of common-setup.bash across all test files
- Impact: Code maintenance burden; changes to setup logic must be made in 4 places instead of 1
- Severity: Minor (does not block goal achievement, but affects maintainability)
</objective>

<execution_context>
@/home/kotdath/.claude/get-shit-done/workflows/execute-plan.md
@/home/kotdath/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/10-automated-cli-testing/10-VERIFICATION.md
@.planning/phases/10-automated-cli-testing/10-01-SUMMARY.md
@.planning/phases/10-automated-cli-testing/10-02-SUMMARY.md
@.planning/phases/10-automated-cli-testing/10-03-SUMMARY.md

# Gap Context from 10-VERIFICATION.md

**Gap 2: Inconsistent common-setup Usage (Minor)**

Files 02-tools-call.bats, 03-resources.bats, and 04-prompts.bats use direct helper loading instead of the common-setup.bash helper. This results in ~30 lines of duplicated code across 3 files.

**Current pattern (02, 03, 04):**
```bash
load "${BATS_TEST_DIRNAME}/test_helper/bats-support/load.bash"
load "${BATS_TEST_DIRNAME}/test_helper/bats-assert/load.bash"
load "${BATS_TEST_DIRNAME}/test_helper/bats-file/load.bash"

PROJECT_ROOT="$(cd "${BATS_TEST_DIRNAME}/../.." && pwd)"
export MCPP_DEBUG=1

setup() {
    export PATH="${PROJECT_ROOT}/build/examples:${PATH}"
}
```

**Desired pattern (01, 05, 06):**
```bash
load 'test_helper/common-setup'

setup() {
    _common_setup
}
```

# Existing Work from 10-01-SUMMARY.md

From 10-01-SUMMARY.md, the common-setup.bash helper provides:
- _common_setup() function with all setup logic
- Loads bats-support, bats-assert, bats-file automatically
- Sets PROJECT_ROOT from BATS_TEST_FILENAME
- Exports MCPP_DEBUG=1
- Adds build/examples to PATH
- Utility functions: inspector_server_path, wait_for_file, wait_for_content

Files already using common-setup correctly:
- 01-tools-list.bats
- 05-initialize.bats
- 06-lifecycle.bats
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor 02-tools-call.bats to use common-setup</name>
  <files>tests/cli/02-tools-call.bats</files>
  <action>
Refactor tests/cli/02-tools-call.bats to use common-setup helper:

**Remove lines 8-22 (duplicated setup code):**
```bash
# Load bats helper libraries
load "${BATS_TEST_DIRNAME}/test_helper/bats-support/load.bash"
load "${BATS_TEST_DIRNAME}/test_helper/bats-assert/load.bash"
load "${BATS_TEST_DIRNAME}/test_helper/bats-file/load.bash"

# Determine project root from test file location
PROJECT_ROOT="$(cd "${BATS_TEST_DIRNAME}/../.." && pwd)"

# Export MCPP_DEBUG for server debug output during tests
export MCPP_DEBUG=1

setup() {
    # Add build/examples to PATH so tests can find inspector_server
    export PATH="${PROJECT_ROOT}/build/examples:${PATH}"
}
```

**Replace with (at line 8):**
```bash
# Load common setup for test environment
load 'test_helper/common-setup'

# Setup function - runs before each test
setup() {
    _common_setup
}
```

**Why this change:**
- Eliminates ~15 lines of duplicated code
- Uses centralized _common_setup() function
- Consistent with 01-tools-list.bats, 05-initialize.bats, 06-lifecycle.bats
- All helper loading and setup logic in one place

**Do NOT:**
- Modify any test logic (the @test blocks)
- Change test assertions or validation
- Alter the order of tests
- Modify helper functions defined in this file (if any exist beyond setup)
  </action>
  <verify>
1. tests/cli/02-tools-call.bats starts with `load 'test_helper/common-setup'`
2. File contains `setup() { _common_setup }` pattern
3. File does NOT contain direct load statements for bats-support, bats-assert, bats-file
4. File does NOT contain PROJECT_ROOT calculation
5. File does NOT contain export MCPP_DEBUG=1
6. All tests still pass: `bats tests/cli/02-tools-call.bats`
  </verify>
  <done>
02-tools-call.bats refactored to:
- Use load 'test_helper/common-setup' for helper loading
- Call _common_setup() in setup() function
- Eliminate 15 lines of duplicated setup code
- Match pattern used by 01-tools-list.bats, 05-initialize.bats, 06-lifecycle.bats
- All 13 tests still pass
  </done>
</task>

<task type="auto">
  <name>Task 2: Refactor 03-resources.bats to use common-setup</name>
  <files>tests/cli/03-resources.bats</files>
  <action>
Refactor tests/cli/03-resources.bats to use common-setup helper:

**Remove lines 8-22 (duplicated setup code):**
```bash
# Load bats helper libraries
load "${BATS_TEST_DIRNAME}/test_helper/bats-support/load.bash"
load "${BATS_TEST_DIRNAME}/test_helper/bats-assert/load.bash"
load "${BATS_TEST_DIRNAME}/test_helper/bats-file/load.bash"

# Determine project root from test file location
PROJECT_ROOT="$(cd "${BATS_TEST_DIRNAME}/../.." && pwd)"

# Export MCPP_DEBUG for server debug output during tests
export MCPP_DEBUG=1

setup() {
    # Add build/examples to PATH so tests can find inspector_server
    export PATH="${PROJECT_ROOT}/build/examples:${PATH}"
}
```

**Replace with (at line 8):**
```bash
# Load common setup for test environment
load 'test_helper/common-setup'

# Setup function - runs before each test
setup() {
    _common_setup
}
```

**Do NOT:**
- Modify any test logic (the @test blocks)
- Change test assertions or validation
- Alter the order of tests
- Modify helper functions defined in this file (if any exist beyond setup)
  </action>
  <verify>
1. tests/cli/03-resources.bats starts with `load 'test_helper/common-setup'`
2. File contains `setup() { _common_setup }` pattern
3. File does NOT contain direct load statements for bats helpers
4. File does NOT contain PROJECT_ROOT calculation
5. File does NOT contain export MCPP_DEBUG=1
6. All tests still pass: `bats tests/cli/03-resources.bats`
  </verify>
  <done>
03-resources.bats refactored to:
- Use load 'test_helper/common-setup' for helper loading
- Call _common_setup() in setup() function
- Eliminate 15 lines of duplicated setup code
- Match pattern used by other test files
- All 9 tests still pass
  </done>
</task>

<task type="auto">
  <name>Task 3: Refactor 04-prompts.bats to use common-setup</name>
  <files>tests/cli/04-prompts.bats</files>
  <action>
Refactor tests/cli/04-prompts.bats to use common-setup helper:

**Remove lines 8-22 (duplicated setup code):**
```bash
# Load bats helper libraries
load "${BATS_TEST_DIRNAME}/test_helper/bats-support/load.bash"
load "${BATS_TEST_DIRNAME}/test_helper/bats-assert/load.bash"
load "${BATS_TEST_DIRNAME}/test_helper/bats-file/load.bash"

# Determine project root from test file location
PROJECT_ROOT="$(cd "${BATS_TEST_DIRNAME}/../.." && pwd)"

# Export MCPP_DEBUG for server debug output during tests
export MCPP_DEBUG=1

setup() {
    # Add build/examples to PATH so tests can find inspector_server
    export PATH="${PROJECT_ROOT}/build/examples:${PATH}"
}
```

**Replace with (at line 8):**
```bash
# Load common setup for test environment
load 'test_helper/common-setup'

# Setup function - runs before each test
setup() {
    _common_setup
}
```

**Do NOT:**
- Modify any test logic (the @test blocks)
- Change test assertions or validation
- Alter the order of tests
- Modify helper functions defined in this file (if any exist beyond setup)
  </action>
  <verify>
1. tests/cli/04-prompts.bats starts with `load 'test_helper/common-setup'`
2. File contains `setup() { _common_setup }` pattern
3. File does NOT contain direct load statements for bats helpers
4. File does NOT contain PROJECT_ROOT calculation
5. File does NOT contain export MCPP_DEBUG=1
6. All tests still pass: `bats tests/cli/04-prompts.bats`
  </verify>
  <done>
04-prompts.bats refactored to:
- Use load 'test_helper/common-setup' for helper loading
- Call _common_setup() in setup() function
- Eliminate 15 lines of duplicated setup code
- Match pattern used by other test files
- All 10 tests still pass
  </done>
</task>

<task type="auto">
  <name>Task 4: Verify all CLI tests pass after refactoring</name>
  <files>tests/cli/*.bats</files>
  <action>
Run full CLI test suite to verify refactoring didn't break anything:

**Run all CLI tests:**
```bash
export PATH="/home/kotdath/omp/personal/cpp/mcpp/tests/cli/bats/bin:$PATH"
cd /home/kotdath/omp/personal/cpp/mcpp
bats tests/cli/
```

**Expected output:**
- All 45+ tests pass
- No failures or errors
- Test count matches or exceeds pre-refactoring count

**Verify consistency:**
```bash
# Confirm all files use common-setup
grep -L "load 'test_helper/common-setup'" tests/cli/*.bats
```
Expected: No output (all files use common-setup)

**Confirm no duplicated setup code:**
```bash
# Check for direct bats-support loads (should be none)
grep -l "bats-support/load.bash" tests/cli/*.bats
```
Expected: No output (no direct loads)

**Confirm no duplicated PROJECT_ROOT:**
```bash
# Check for PROJECT_ROOT calculations (should be none in test files)
grep -l 'PROJECT_ROOT=' tests/cli/*.bats
```
Expected: Only common-setup.bash listed
  </action>
  <verify>
1. All CLI tests pass: `bats tests/cli/` returns 0
2. Test count >= 45 (all tests still running)
3. All 6 test files use common-setup: grep confirms
4. No direct bats helper loads in any test file
5. No duplicated PROJECT_ROOT calculations in test files
6. Only common-setup.bash contains setup logic
  </verify>
  <done>
Full CLI test suite verified:
- All 45+ tests pass after refactoring
- All 6 test files use common-setup consistently
- No duplicated setup code across test files
- Setup logic centralized in common-setup.bash
- Future changes to setup only require updating one file
  </done>
</task>

</tasks>

<verification>
**Overall phase checks:**

1. **Consistent common-setup usage:**
   ```bash
   grep "load 'test_helper/common-setup'" tests/cli/*.bats | wc -l
   ```
   Expected: 6 (all test files)

2. **No duplicated helper loading:**
   ```bash
   grep "bats-support/load.bash" tests/cli/*.bats
   ```
   Expected: No matches (all loads via common-setup)

3. **No duplicated PROJECT_ROOT:**
   ```bash
   grep "PROJECT_ROOT=" tests/cli/*.bats
   ```
   Expected: Only common-setup.bash contains PROJECT_ROOT

4. **All tests still pass:**
   ```bash
   export PATH="$PWD/tests/cli/bats/bin:$PATH"
   bats tests/cli/
   ```
   Expected: All 45+ tests pass

**Gap closure verification:**
- [ ] All 6 test files use common-setup.bash helper
- [ ] No duplicated helper loading code across test files
- [ ] Setup logic centralized in one file
- [ ] All tests pass after refactoring
</verification>

<success_criteria>
**Measurable completion:**

1. All 6 test files start with `load 'test_helper/common-setup'`
2. Zero test files contain direct load statements for bats-support, bats-assert, bats-file
3. Zero test files calculate PROJECT_ROOT (only in common-setup.bash)
4. `bats tests/cli/` runs all 45+ tests successfully
5. Code duplication eliminated: ~45 lines removed across 3 files

**Observable behavior:**
- Changes to test setup only require modifying common-setup.bash
- All test files follow same pattern as 01-tools-list.bats
- New test files can simply `load 'test_helper/common-setup'` and call `_common_setup()`
</success_criteria>

<output>
After completion, create `.planning/phases/10-automated-cli-testing/10-06-SUMMARY.md` documenting:
- 3 test files refactored (02, 03, 04)
- ~45 lines of duplicated code eliminated
- All 6 test files now use common-setup consistently
- All 45+ tests still pass
- Gap 2 (Inconsistent common-setup Usage) closed
</output>
