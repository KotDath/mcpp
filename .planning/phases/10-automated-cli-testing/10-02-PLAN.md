---
phase: 10-automated-cli-testing
plan: 02
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - tests/cli/05-initialize.bats
  - tests/cli/01-tools-list.bats
autonomous: true

must_haves:
  truths:
    - "initialize test validates protocol version 2025-11-25"
    - "tools/list test validates JSON-RPC response structure"
    - "JSON responses validated using jq -e for structure checking"
    - "assert_output and assert_success assertions used correctly"
  artifacts:
    - path: "tests/cli/05-initialize.bats"
      provides: "Initialize handshake tests"
      contains: "initialize"
      min_lines: 30
    - path: "tests/cli/01-tools-list.bats"
      provides: "Tools/list endpoint tests"
      contains: "tools/list"
      min_lines: 30
  key_links:
    - from: "tests/cli/05-initialize.bats"
      to: "tests/cli/test_helper/common-setup.sh"
      via: "load 'test_helper/common-setup'"
    - from: "tests/cli/01-tools-list.bats"
      to: "examples/inspector_server"
      via: "stdio pipe communication"
    - from: "tests/cli/*.bats"
      to: "jq"
      via: "JSON validation with jq -e"
---

<objective>
Create basic protocol tests for initialize handshake and tools/list endpoint.

Purpose: Validate the fundamental MCP protocol operations - the initialize handshake that establishes the protocol version, and the tools/list endpoint that discovers available tools. These tests establish the pattern for JSON-RPC request/response testing using bats-core and jq.

Output: tests/cli/05-initialize.bats and tests/cli/01-tools-list.bats test files
</objective>

<execution_context>
@/home/kotdath/.claude/get-shit-done/workflows/execute-plan.md
@/home/kotdath/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-automated-cli-testing/10-RESEARCH.md
@.planning/phases/10-automated-cli-testing/10-01-SUMMARY.md
@.planning/phases/09-inspector-server-integration/09-03-SUMMARY.md

# Phase 09-03 Context
inspector_server.cpp implements:
- Initialize handshake with protocolVersion "2025-11-25"
- 4 tools: calculate, echo, get_time, server_info
- Stdio transport with Content-Length headers

# Phase 10-01 Context
common-setup.sh provides:
- Helper library loading (bats-support, bats-assert, bats-file)
- PATH configuration to build/examples
- MCPP_DEBUG=1 environment variable
</context>

<tasks>

<task type="auto">
  <name>Create 05-initialize.bats for initialize handshake tests</name>
  <files>tests/cli/05-initialize.bats</files>
  <action>
    Create tests/cli/05-initialize.bats with the following tests:

    1. Test: "initialize request returns valid JSON-RPC response"
       - Send initialize request with protocolVersion "2025-11-25"
       - Verify response contains "jsonrpc": "2.0"
       - Verify response contains "result" with server info
       - Use assert_output --partial for key fields

    2. Test: "initialize returns correct protocol version"
       - Send initialize request
       - Use jq to extract .result.protocolVersion
       - Assert equals "2025-11-25"

    3. Test: "initialize returns server capabilities"
       - Send initialize request
       - Use jq to check .result.capabilities.tools exists
       - Use jq to check .result.capabilities.resources exists
       - Use jq to check .result.capabilities.prompts exists

    4. Test: "initialize returns server info"
       - Send initialize request
       - Use jq to check .result.serverInfo.name exists
       - Use jq to check .result.serverInfo.version exists

    File structure:
    - Load common-setup in setup() function
    - Use @test annotations for each test
    - Use run bash -c for commands that pipe output
    - Use jq -e for JSON validation (returns 0 if valid)
    - Use assert_success for exit code checking
    - Use assert_output for response validation

    Reference RESEARCH.md Pattern 3 (JSON-RPC Request/Response Testing).
  </action>
  <verify>
    1. File exists and has .bats extension
    2. File contains at least 4 @test blocks
    3. File loads common-setup: `grep "load 'test_helper/common-setup'" tests/cli/05-initialize.bats`
    4. File uses jq for JSON validation: `grep "jq -e" tests/cli/05-initialize.bats`
    5. Check syntax: `tests/cli/bats/bin/bats --dry-run tests/cli/05-initialize.bats` (if bats supports it)
  </verify>
  <done>
    - 05-initialize.bats created with 4 tests covering initialize handshake
    - All tests use common-setup.sh for environment configuration
    - JSON validation uses jq -e for structure checking
  </done>
</task>

<task type="auto">
  <name>Create 01-tools-list.bats for tools/list endpoint</name>
  <files>tests/cli/01-tools-list.bats</files>
  <action>
    Create tests/cli/01-tools-list.bats with the following tests:

    1. Test: "tools/list returns valid JSON-RPC response"
       - Send initialize first (required by MCP protocol)
       - Send tools/list request
       - Verify response contains "jsonrpc": "2.0"
       - Verify response contains "id"
       - Verify response contains "result"
       - Use assert_output --partial

    2. Test: "tools/list returns expected tools"
       - Send initialize and tools/list
       - Use jq to extract .result.tools[].name
       - Verify "calculate", "echo", "get_time", "server_info" exist
       - Use jq -e '.result.tools[] | select(.name == "calculate")'

    3. Test: "tools/list tools have schema"
       - Send initialize and tools/list
       - Use jq to check each tool has inputSchema
       - Verify calculate tool has operation property in schema
       - Verify calculate tool has a, b properties in schema

    4. Test: "tools/list before initialize fails gracefully"
       - Send tools/list WITHOUT initialize first
       - Verify server doesn't crash
       - Verify response exists (may be error or empty result)

    Use the same patterns as 05-initialize.bats:
    - Load common-setup in setup()
    - Use run bash -c for piped commands
    - Use jq -e for JSON validation
    - Use assert_success and assert_output

    Reference RESEARCH.md Pattern 3.
  </action>
  <verify>
    1. File exists and has .bats extension
    2. File contains at least 4 @test blocks
    3. File loads common-setup
    4. File tests tools/list endpoint specifically
    5. File verifies expected tools from inspector_server (calculate, echo, get_time, server_info)
  </verify>
  <done>
    - 01-tools-list.bats created with 4 tests covering tools/list endpoint
    - Tests verify all 4 expected tools are returned
    - Tests validate JSON structure and schema presence
  </done>
</task>

</tasks>

<verification>
After completing this plan:
1. Both .bats files exist in tests/cli/
2. Each file loads common-setup.sh
3. Each file uses jq for JSON validation
4. Test count: `grep -c "@test" tests/cli/05-initialize.bats` >= 4
5. Test count: `grep -c "@test" tests/cli/01-tools-list.bats` >= 4
</verification>

<success_criteria>
1. Initialize handshake tests validate protocol version 2025-11-25
2. tools/list tests verify all 4 expected tools are returned
3. All JSON responses validated using jq -e
4. Test files follow bats-core conventions (setup(), @test, assertions)
</success_criteria>

<output>
After completion, create `.planning/phases/10-automated-cli-testing/10-02-SUMMARY.md`
</output>
