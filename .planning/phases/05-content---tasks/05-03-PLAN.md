---
phase: 05-content---tasks
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/mcpp/server/tool_registry.h
  - src/mcpp/server/tool_registry.cpp
  - src/mcpp/server/resource_registry.h
  - src/mcpp/server/resource_registry.cpp
  - src/mcpp/server/prompt_registry.h
  - src/mcpp/server/prompt_registry.cpp
autonomous: true

must_haves:
  truths:
    - "Registry sends list_changed notification when items are added/removed"
    - "Developer can set callback for sending notifications via set_notify_callback()"
    - "Registry calls notify callback after register_* operations"
    - "Registry provides notify_changed() method for manual notification"
    - "McpServer routes list_changed notifications to transport"
    - "Notifications only sent when client capability is enabled"
  artifacts:
    - path: "src/mcpp/server/tool_registry.h"
      provides: "List changed notification support for tools"
      contains: "set_notify_callback", "notify_changed", "NotifyCallback"
    - path: "src/mcpp/server/resource_registry.h"
      provides: "List changed notification support for resources"
      contains: "set_notify_callback", "notify_changed", "NotifyCallback"
    - path: "src/mcpp/server/prompt_registry.h"
      provides: "List changed notification support for prompts"
      contains: "set_notify_callback", "notify_changed", "NotifyCallback"
  key_links:
    - from: "src/mcpp/server/tool_registry.h"
      to: "src/mcpp/client/roots.h"
      via: "pattern following"
      pattern: "using NotifyCallback.*std::function<void"
    - from: "src/mcpp/server/mcp_server.h"
      to: "registries"
      via: "notification routing"
      pattern: "set_notify_callback"
---

<objective>
Implement list_changed notifications for tools, resources, and prompts registries following the RootsManager callback pattern.

Purpose: Clients need to know when registry contents change to refresh caches and UI. Mutual opt-in via capability negotiation and callbacks.

Output: All three registries support notification callbacks, McpServer routes notifications to transport.
</objective>

<execution_context>
@/home/kotdath/.claude/get-shit-done/workflows/execute-plan.md
@/home/kotdath/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-content---tasks/05-RESEARCH.md

# Pattern to follow
@src/mcpp/client/roots.h (lines 129-202) — RootsManager with NotifyCallback pattern
@src/mcpp/protocol/capabilities.h (lines 77-98) — ToolCapability, ResourceCapability, PromptCapability with listChanged
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add notification support to ToolRegistry</name>
  <files>src/mcpp/server/tool_registry.h src/mcpp/server/tool_registry.cpp</files>
  <action>
Modify tool_registry.h:

1. Add public typedef after ToolHandler (around line 82):
   ```cpp
   /**
    * @brief Callback type for list_changed notifications
    *
    * Invoked when the registry contents change (tools added/removed).
    */
   using NotifyCallback = std::function<void()>;
   ```

2. Add public methods after call_tool() (around line 257):
   ```cpp
   /**
    * @brief Set the callback for sending list_changed notifications
    *
    * The callback will be invoked when notify_changed() is called.
    * Typically used to send notifications/tools/list_changed to clients.
    *
    * @param cb Callback function (empty function to clear)
    */
   void set_notify_callback(NotifyCallback cb);

   /**
    * @brief Send tools/list_changed notification
    *
    * If a notify callback is registered, invokes it to send the notification.
    * Call this after registering/unregistering tools to notify clients.
    */
   void notify_changed();
   ```

3. Add private member after tools_ (line 287):
   ```cpp
   /// Callback for sending list_changed notifications
   NotifyCallback notify_cb_;
   ```

Modify tool_registry.cpp:

4. Implement set_notify_callback():
   ```cpp
   void ToolRegistry::set_notify_callback(NotifyCallback cb) {
       notify_cb_ = std::move(cb);
   }
   ```

5. Implement notify_changed():
   ```cpp
   void ToolRegistry::notify_changed() {
       if (notify_cb_) {
           notify_cb_();
       }
   }
   ```

6. Update register_tool() implementations to call notify_changed():
   - After successful registration in both overloaded methods
   - Add: notify_changed(); after return true lines (before return)
   - Use separate variable to track success, call notify_changed() before returning

Example pattern:
   ```cpp
   bool result = tools_.emplace(...).second;
   if (result) {
       notify_changed();
   }
   return result;
   ```
  </action>
  <verify>grep -E "(set_notify_callback|notify_changed|notify_cb_)" src/mcpp/server/tool_registry.h src/mcpp/server/tool_registry.cpp</verify>
  <done>ToolRegistry has notification support with callback pattern and automatic notification on register</done>
</task>

<task type="auto">
  <name>Task 2: Add notification support to ResourceRegistry</name>
  <files>src/mcpp/server/resource_registry.h src/mcpp/server/resource_registry.cpp</files>
  <action>
Modify resource_registry.h:

1. Add public typedef after TemplateResourceHandler (around line 150):
   ```cpp
   /**
    * @brief Callback type for list_changed notifications
    *
    * Invoked when the registry contents change (resources added/removed).
    */
   using NotifyCallback = std::function<void()>;
   ```

2. Add public methods after get_completion() (around line 425):
   ```cpp
   /**
    * @brief Set the callback for sending list_changed notifications
    *
    * The callback will be invoked when notify_changed() is called.
    * Typically used to send notifications/resources/list_changed to clients.
    *
    * @param cb Callback function (empty function to clear)
    */
   void set_notify_callback(NotifyCallback cb);

   /**
    * @brief Send resources/list_changed notification
    *
    * If a notify callback is registered, invokes it to send the notification.
    * Call this after registering/unregistering resources to notify clients.
    */
   void notify_changed();
   ```

3. Add private member after completion_handlers_ (line 451):
   ```cpp
   /// Callback for sending list_changed notifications
   NotifyCallback notify_cb_;
   ```

Modify resource_registry.cpp:

4. Implement set_notify_callback() and notify_changed() following same pattern as ToolRegistry

5. Update register_resource() and register_template() to call notify_changed() after successful registration

6. Note: ResourceRegistry already has a different notify mechanism for resource updates (notify_updated for subscriptions) - keep that separate
  </action>
  <verify>grep -E "(set_notify_callback|notify_changed|notify_cb_)" src/mcpp/server/resource_registry.h src/mcpp/server/resource_registry.cpp</verify>
  <done>ResourceRegistry has notification support, separate from existing subscription notification</done>
</task>

<task type="auto">
  <name>Task 3: Add notification support to PromptRegistry</name>
  <files>src/mcpp/server/prompt_registry.h src/mcpp/server/prompt_registry.cpp</files>
  <action>
Modify prompt_registry.h:

1. Add public typedef after CompletionHandler (around line 74):
   ```cpp
   /**
    * @brief Callback type for list_changed notifications
    *
    * Invoked when the registry contents change (prompts added/removed).
    */
   using NotifyCallback = std::function<void()>;
   ```

2. Add public methods after get_completion() (around line 230):
   ```cpp
   /**
    * @brief Set the callback for sending list_changed notifications
    *
    * The callback will be invoked when notify_changed() is called.
    * Typically used to send notifications/prompts/list_changed to clients.
    *
    * @param cb Callback function (empty function to clear)
    */
   void set_notify_callback(NotifyCallback cb);

   /**
    * @brief Send prompts/list_changed notification
    *
    * If a notify callback is registered, invokes it to send the notification.
    * Call this after registering/unregistering prompts to notify clients.
    */
   void notify_changed();
   ```

3. Add private member after completion_handlers_ (line 236):
   ```cpp
   /// Callback for sending list_changed notifications
   NotifyCallback notify_cb_;
   ```

Modify prompt_registry.cpp:

4. Implement set_notify_callback() and notify_changed() following same pattern as ToolRegistry

5. Update register_prompt() to call notify_changed() after successful registration
  </action>
  <verify>grep -E "(set_notify_callback|notify_changed|notify_cb_)" src/mcpp/server/prompt_registry.h src/mcpp/server/prompt_registry.cpp</verify>
  <done>PromptRegistry has notification support with callback pattern</done>
</task>

</tasks>

<verification>
After plan completion:

1. All three registries have NotifyCallback typedef
2. All three registries have set_notify_callback() and notify_changed() methods
3. Each registry calls notify_changed() after successful registration
4. notify_changed() only invokes callback if one is set (no-op otherwise)
5. Pattern matches RootsManager implementation for consistency
</verification>

<success_criteria>
1. ToolRegistry notification support implemented
2. ResourceRegistry notification support implemented
3. PromptRegistry notification support implemented
4. All registries follow the same callback pattern
5. Automatic notification on successful registration
6. Library compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-content---tasks/05-03-SUMMARY.md`
</output>
