---
phase: 02-core-server
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/mcpp/server/prompt_registry.h
  - src/mcpp/server/prompt_registry.cpp
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Library consumer can register prompts with name and argument definitions"
    - "Library consumer can call prompts/list and receive prompt discovery metadata"
    - "Library consumer can retrieve prompts via prompts/get with argument substitution"
    - "Prompts return array of PromptMessage with role and content"
  artifacts:
    - path: "src/mcpp/server/prompt_registry.h"
      provides: "Prompt registration and retrieval with argument substitution"
      min_lines: 70
      contains: "class PromptRegistry", "struct PromptRegistration", "using PromptHandler", "struct PromptMessage"
  key_links:
    - from: "src/mcpp/server/prompt_registry.h"
      to: "src/mcpp/server/tool_registry.h"
      via: "Similar handler registration pattern"
      pattern: "using.*Handler|struct.*Registration"
---

<objective>
Implement prompt registration, discovery, and retrieval with argument substitution and message templates.

Purpose: Prompts enable servers to expose reusable prompt templates that clients can use as starting points for LLM interactions. Prompt discovery (prompts/list) and retrieval (prompts/get) are core server capabilities. Argument substitution allows prompts to be parameterized.

Output: Working prompt registry with registration, discovery, and retrieval; support for argument definitions; message templates with role and content.
</objective>

<execution_context>
@/home/kotdath/.claude/get-shit-done/workflows/execute-plan.md
@/home/kotdath/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-core-server**---tools,-resources,-prompts-with-stdio-transport-and-progress-support/02-CONTEXT.md
@.planning/phases/02-core-server**---tools,-resources,-prompts-with-stdio-transport-and-progress-support/02-RESEARCH.md
@src/mcpp/core/json_rpc.h
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create prompt types and handler signatures</name>
  <files>src/mcpp/server/prompt_registry.h</files>
  <action>
Create src/mcpp/server/prompt_registry.h with:

1. Include guards and includes:
   - #include <nlohmann/json.hpp>
   - #include <functional>
   - #include <string>
   - #include <unordered_map>
   - #include <optional>
   - #include <vector>

2. namespace mcpp::server

3. Prompt message type (following RESEARCH.md "Prompt Handler with Argument Substitution" example):
   ```cpp
   struct PromptMessage {
       std::string role;  // "user" or "assistant"
       nlohmann::json content;  // TextContent, ImageContent, etc.
   };
   ```

4. Prompt argument definition:
   ```cpp
   struct PromptArgument {
       std::string name;
       std::optional<std::string> description;
       bool required = false;
   };
   ```

5. Prompt handler signature:
   ```cpp
   using PromptHandler = std::function<std::vector<PromptMessage>(
       const std::string& name,
       const nlohmann::json& arguments
   )>;
   ```

6. Prompt registration struct:
   ```cpp
   struct PromptRegistration {
       std::string name;
       std::optional<std::string> description;
       std::vector<PromptArgument> arguments;
       PromptHandler handler;
   };
   ```

Follow CONTEXT.md "Prompt registration" decisions exactly. Handler returns completed message array after argument substitution.
Arguments are passed as JSON object from client.
  </action>
  <verify>grep -E "struct PromptMessage|struct PromptArgument|struct PromptRegistration|using PromptHandler" src/mcpp/server/prompt_registry.h</verify>
  <done>prompt_registry.h defines PromptMessage with role/content, PromptArgument with name/description/required, PromptRegistration with arguments list, and PromptHandler function type</done>
</task>

<task type="auto">
  <name>Task 2: Create PromptRegistry class with registration and retrieval</name>
  <files>src/mcpp/server/prompt_registry.h src/mcpp/server/prompt_registry.cpp</files>
  <action>
Extend prompt_registry.h and create prompt_registry.cpp with:

1. In prompt_registry.h, add PromptRegistry class:
   ```cpp
   class PromptRegistry {
   public:
       // Register a prompt
       bool register_prompt(
           const std::string& name,
           const std::optional<std::string>& description,
           const std::vector<PromptArgument>& arguments,
           PromptHandler handler
       );

       // List all registered prompts
       std::vector<nlohmann::json> list_prompts() const;

       // Get a prompt by name with arguments
       std::optional<nlohmann::json> get_prompt(
           const std::string& name,
           const nlohmann::json& arguments
       ) const;

       // Check if prompt exists
       bool has_prompt(const std::string& name) const;

   private:
       std::unordered_map<std::string, PromptRegistration> prompts_;
   };
   ```

2. In prompt_registry.cpp, implement methods:
   - register_prompt: Store in prompts_ map with name as key
   - list_prompts: Return array of prompt objects with name, optional description, arguments array
   - get_prompt:
     * Find prompt by name
     * Call handler with provided arguments (handler does substitution)
     * Convert result to MCP GetPromptResult format:
       ```json
       {
         "messages": [
           {"role": "user", "content": {"type": "text", "text": "..."}},
           ...
         ]
       }
       ```
     * Return std::nullopt if name not found
   - has_prompt: Check if name exists

The handler is responsible for argument substitution into the message templates.
  </action>
  <verify>grep -E "class PromptRegistry|register_prompt|list_prompts|get_prompt|has_prompt" src/mcpp/server/prompt_registry.h src/mcpp/server/prompt_registry.cpp</verify>
  <done>PromptRegistry provides register_prompt, list_prompts, get_prompt, has_prompt with name-based lookup and MCP-compliant response format</done>
</task>

</tasks>

<verification>
- prompt_registry.h defines PromptMessage with role (user/assistant) and content (JSON)
- PromptRegistration includes arguments list with name, optional description, required flag
- PromptRegistry::list_prompts returns array with name, optional description, arguments
- PromptRegistry::get_prompt calls handler with arguments and returns messages array
- Handler receives raw arguments JSON for template substitution
</verification>

<success_criteria>
Prompt registry supports registration, discovery, and retrieval.
Prompts return proper MCP GetPromptResult format with messages array.
Argument definitions include name, optional description, and required flag.
Handler receives arguments for substitution into message templates.
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-server/02-03-SUMMARY.md`
</output>
