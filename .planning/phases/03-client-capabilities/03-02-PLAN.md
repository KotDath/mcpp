---
phase: 03-client-capabilities
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/mcpp/client/roots.h
  - src/mcpp/client/roots.cpp
  - src/mcpp/protocol/capabilities.h
  - src/mcpp/client.h
  - src/mcpp/client.cpp
autonomous: true

must_haves:
  truths:
    - "RootsManager can store and retrieve root URIs"
    - "Root URIs are validated to start with 'file://' prefix"
    - "roots/list request handler returns current roots list"
    - "roots/list_changed notification can be sent when roots change"
    - "ClientCapabilities.roots can be advertised during initialize"
    - "RootsManager notifies callback when roots change"
    - "Optional name field is supported for each root"
  artifacts:
    - path: "src/mcpp/client/roots.h"
      provides: "Roots management types (Root, ListRootsResult, RootsManager)"
      min_lines: 80
    - path: "src/mcpp/client/roots.cpp"
      provides: "RootsManager implementation"
      min_lines: 60
    - path: "src/mcpp/protocol/capabilities.h"
      provides: "ClientCapabilities.roots field"
      contains: "RootsCapability"
  key_links:
    - from: "src/mcpp/client.cpp"
      to: "mcpp::client::RootsManager"
      via: "Register roots/list handler"
      pattern: "roots/list"
    - from: "src/mcpp/client.cpp"
      to: "mcpp::client::RootsManager"
      via: "Send list_changed notification"
      pattern: "roots/list_changed"
---

<objective>
Implement roots management for MCP clients to advertise file:// URIs to servers with list_changed notification support.

Purpose: Enable MCP servers to discover which root directories/files the client allows access to. Roots are the server's view of accessible filesystem - critical for tools that operate on files. Per MCP spec, roots must be file:// URIs only (for now).

Output: Root type, ListRootsResult, RootsManager class with set_roots/get_roots/notify_changed, roots/list request handler, and roots/list_changed notification support.

Context: CLNT-01 requirement (Roots support). Roots are specified in MCP 2025-11-25 schema with explicit "file://" requirement. Server sends roots/list request; client returns roots. Client sends roots/list_changed notification when roots change (user opens new project).
</object>

<execution_context>
@/home/kotdath/.claude/get-shit-done/workflows/execute-plan.md
@/home/kotdath/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-client-capabilities/03-RESEARCH.md

@src/mcpp/client.h
@src/mcpp/protocol/capabilities.h
@src/mcpp/core/json_rpc.h
</context>

<tasks>

<task type="auto">
  <name>Create roots types and manager</name>
  <files>src/mcpp/client/roots.h</files>
  <action>
    Create src/mcpp/client/roots.h with:

    1. Include guards: MCPP_CLIENT_ROOTS_H
    2. Includes: <vector>, <string>, <optional>, <functional>, <nlohmann/json.hpp>

    3. Root struct:
       - std::string uri - MUST start with "file://"
       - std::optional<std::string> name - optional display name
       - Method: bool is_valid() const - returns uri.rfind("file://", 0) == 0

    4. ListRootsResult struct (for roots/list response):
       - std::vector<Root> roots
       - Method: JsonValue to_json() const - returns {{"roots", json array}}

    5. RootsManager class:
       - Public:
         * void set_roots(std::vector<Root> roots) - replaces current roots
         * const std::vector<Root>& get_roots() const - returns current roots
         * void set_notify_callback(std::function<void()> cb) - register callback for changes
         * void notify_changed() - send list_changed notification (calls callback if set)
         * static bool validate_uri(const std::string& uri) - checks file:// prefix
       - Private:
         * std::vector<Root> roots_
         * std::function<void()> notify_cb_

    All in mcpp::client namespace. MIT license header.
  </action>
  <verify>grep -c "struct Root" src/mcpp/client/roots.h returns 1</verify>
  <done>roots.h defines Root, ListRootsResult, and RootsManager with file:// URI validation</done>
</task>

<task type="auto">
  <name>Implement roots manager</name>
  <files>src/mcpp/client/roots.cpp</files>
  <action>
    Create src/mcpp/client/roots.cpp with:

    1. Include "mcpp/client/roots.h"
    2. MIT license header

    3. Root::is_valid(): return uri.rfind("file://", 0) == 0

    4. ListRootsResult::to_json():
       - Build json array of roots
       - Each root: {{"uri", root.uri}, {"name", root.name.value_or("")}}
       - Return {{"roots", array}}

    5. RootsManager::set_roots:
       - Store std::move(roots) in roots_
       - No automatic notification (user calls notify_changed explicitly)

    6. RootsManager::get_roots: return roots_ (const reference)

    7. RootsManager::set_notify_callback: Store std::move(cb) in notify_cb_

    8. RootsManager::notify_changed:
       - If notify_cb_ is set (not nullptr), call it()
       - Otherwise, no-op

    9. RootsManager::validate_uri: return uri.rfind("file://", 0) == 0

    All in mcpp::client namespace.
  </action>
  <verify>grep -c "RootsManager::" src/mcpp/client/roots.cpp returns 5</verify>
  <done>roots.cpp implements all RootsManager methods with file:// URI validation</done>
</task>

<task type="auto">
  <name>Add roots capability to protocol types</name>
  <files>src/mcpp/protocol/capabilities.h</files>
  <action>
    Update src/mcpp/protocol/capabilities.h:

    1. Confirm RootsCapability struct exists (it should):
       - std::optional<bool> listChanged

    2. Confirm ClientCapabilities has roots field (it should):
       - std::optional<RootsCapability> roots

    These should already be present from Phase 1. If not, add them following the pattern of other capability fields.
  </action>
  <verify>grep "std::optional<RootsCapability> roots" src/mcpp/protocol/capabilities.h returns the field</verify>
  <done>ClientCapabilities includes optional roots field of type RootsCapability</done>
</task>

<task type="auto">
  <name>Integrate roots with McpClient</name>
  <files>src/mcpp/client.h src/mcpp/client.cpp</files>
  <action>
    Update McpClient to integrate RootsManager:

    1. Add include "mcpp/client/roots.h" to client.h

    2. Add public members:
       - client::RootsManager& get_roots_manager() { return roots_manager_; }
       - const client::RootsManager& get_roots_manager() const { return roots_manager_; }

    3. Add private member: client::RootsManager roots_manager_

    4. In McpClient constructor:
       - Set up roots notification callback to send list_changed:
         roots_manager_.set_notify_callback([this]() {
             send_notification("notifications/roots/list_changed", nullptr);
         });

    5. Register roots/list request handler (in constructor or after connect):
       - Use set_request_handler("roots/list", ...) to return roots list:
         return roots_manager_.get_roots().to_json();

       Parse the result properly - the handler receives params but roots/list has no params, so just return the current roots.

    The roots/list handler should:
    - Ignore params (roots/list has no parameters)
    - Call roots_manager_.get_roots()
    - Convert to JSON using ListRootsResult::to_json() or build manually
  </action>
  <verify>grep "roots_manager_" src/mcpp/client.h returns the member declaration</verify>
  <done>McpClient integrates RootsManager with roots/list handler and roots/list_changed notification</done>
</task>

</tasks>

<verification>
After all tasks complete, verify:

1. **Root types exist**: grep confirms Root struct with uri and name fields
2. **file:// validation**: Root::is_valid() and RootsManager::validate_uri() check file:// prefix
3. **RootsManager methods**: set_roots, get_roots, set_notify_callback, notify_changed all implemented
4. **Client integration**: McpClient has roots_manager_ member and get_roots_manager() accessor
5. **Request handler**: roots/list handler registered, returns current roots
6. **Notification callback**: notify_changed triggers notifications/roots/list_changed

Manual verification (if needed):
- Create RootsManager, set_roots with valid file:// URIs, get_roots returns them
- Set invalid URI (no file:// prefix), is_valid() returns false
- Set notify callback, call notify_changed - callback is invoked
- Access roots_manager_ from McpClient, can set and get roots
</verification>

<success_criteria>
1. Root struct with uri and optional name fields
2. file:// URI validation in Root::is_valid()
3. RootsManager stores and retrieves roots
4. roots/list request handler returns current roots
5. roots/list_changed notification sent on notify_changed()
6. Client can access RootsManager via McpClient
</success_criteria>

<output>
After completion, create `.planning/phases/03-client-capabilities/03-02-SUMMARY.md` with:
- Frontmatter: phase, plan, wave, affects: ["03-client-capabilities"], subsystem: "client", tech-stack-added: [], patterns-established: ["file:// URI validation", "manager with notify callback pattern"], key-files: ["roots.h", "roots.cpp"]
- Summary of roots implementation
- file:// URI validation approach
- Integration with McpClient
- Any deviations from plan
- Next: Sampling support (03-03)
</output>
