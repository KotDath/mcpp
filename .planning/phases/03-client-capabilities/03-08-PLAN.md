---
phase: 03-client-capabilities
plan: 08
type: execute
wave: 1
depends_on: []
files_modified:
  - src/mcpp/protocol/capabilities.h
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "User can easily configure client capabilities for initialization"
    - "Builder helper avoids manual struct construction"
    - "Common capability patterns are pre-configured"
  artifacts:
    - path: "src/mcpp/protocol/capabilities.h"
      provides: "ClientCapabilities builder helper function"
      contains: "build_client_capabilities"
    - path: "src/mcpp/protocol/capabilities.h"
      contains: "ClientCapabilities::Builder"
  key_links:
    - from: "src/mcpp/client.h"
      to: "mcpp::protocol::build_client_capabilities"
      via: "User calls builder to create InitializeRequestParams::capabilities"
      pattern: "build_client_capabilities"
---

<objective>
Add ergonomic builder helper for configuring client capabilities during initialization.

Purpose: Users currently must manually construct ClientCapabilities struct with nested optional structs. A builder helper provides a fluent API for common configurations (roots with listChanged, sampling with tool use, elicitation with form/URL modes).

Output: build_client_capabilities() free function and/or ClientCapabilities::Builder nested class for ergonomic capability configuration.

Context: Gap closure from 03-VERIFICATION.md - secondary ergonomics gap. The capability structs exist but are tedious to construct manually.
</objective>

<execution_context>
@/home/kotdath/.claude/get-shit-done/workflows/execute-plan.md
@/home/kotdath/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/03-client-capabilities/03-VERIFICATION.md
@src/mcpp/protocol/capabilities.h
@src/mcpp/client.h
</context>

<tasks>

<task type="auto">
  <name>Add ClientCapabilities builder helper</name>
  <files>src/mcpp/protocol/capabilities.h</files>
  <action>
    Add a builder helper to capabilities.h for ergonomic client capability configuration.

    After the ClientCapabilities struct definition (around line 44), add:

    ```cpp
    /**
     * Builder helper for constructing ClientCapabilities.
     *
     * Provides a fluent interface for configuring which capabilities
     * the client advertises during initialization.
     *
     * Example usage:
     *   auto caps = ClientCapabilities::Builder()
     *       .with_roots(true)           // Enable roots with listChanged
     *       .with_sampling(true)        // Enable sampling without tool use
     *       .with_elicitation_form()    // Enable elicitation form mode
     *       .build();
     */
    class ClientCapabilitiesBuilder {
    public:
        ClientCapabilitiesBuilder() = default;

        // Enable roots capability
        ClientCapabilitiesBuilder& with_roots(bool list_changed = true) {
            caps_.roots = RootsCapability{list_changed};
            return *this;
        }

        // Enable sampling capability
        ClientCapabilitiesBuilder& with_sampling(bool tools = false) {
            caps_.sampling = SamplingCapability{tools};
            return *this;
        }

        // Enable elicitation form mode
        ClientCapabilitiesBuilder& with_elicitation_form() {
            if (!caps_.elicitation) {
                caps_.elicitation = ElicitationCapability{};
            }
            caps_.elicitation->form = true;
            return *this;
        }

        // Enable elicitation URL mode
        ClientCapabilitiesBuilder& with_elicitation_url() {
            if (!caps_.elicitation) {
                caps_.elicitation = ElicitationCapability{};
            }
            caps_.elicitation->url = true;
            return *this;
        }

        // Enable both elicitation modes
        ClientCapabilitiesBuilder& with_elicitation() {
            return with_elicitation_form().with_elicitation_url();
        }

        // Add experimental capabilities
        ClientCapabilitiesBuilder& with_experimental(CapabilitySet experimental) {
            caps_.experimental = std::move(experimental);
            return *this;
        }

        // Build the ClientCapabilities struct
        ClientCapabilities build() && {
            return std::move(caps_);
        }

        // Build the ClientCapabilities struct (lvalue)
        ClientCapabilities build() const & {
            return caps_;
        }

    private:
        ClientCapabilities caps_;
    };

    // Convenience free function for simple cases
    inline ClientCapabilities build_client_capabilities(
        bool roots = false,
        bool sampling = false,
        bool elicitation_form = false,
        bool elicitation_url = false
    ) {
        ClientCapabilitiesBuilder builder;
        if (roots) builder.with_roots();
        if (sampling) builder.with_sampling();
        if (elicitation_form || elicitation_url) {
            if (elicitation_form) builder.with_elicitation_form();
            if (elicitation_url) builder.with_elicitation_url();
        }
        return std::move(builder).build();
    }
    ```

    Also add a Builder typedef to ClientCapabilities:
    ```cpp
    struct ClientCapabilities {
        std::optional<CapabilitySet> experimental;
        std::optional<RootsCapability> roots;
        std::optional<SamplingCapability> sampling;
        std::optional<ElicitationCapability> elicitation;

        using Builder = ClientCapabilitiesBuilder;
    };
    ```

    Place the builder class before the ClientCapabilities struct (or after with forward declaration).
  </action>
  <verify>grep -q "ClientCapabilitiesBuilder" src/mcpp/protocol/capabilities.h && grep -q "build_client_capabilities" src/mcpp/protocol/capabilities.h</verify>
  <done>ClientCapabilitiesBuilder class with fluent API and build_client_capabilities free function added</done>
</task>

<task type="auto">
  <name>Update capability structs if needed for builder compatibility</name>
  <files>src/mcpp/protocol/capabilities.h</files>
  <action>
    Verify that RootsCapability, SamplingCapability, and ElicitationCapability have constructors that work with the builder.

    If any capability structs lack proper constructors, add them:

    ```cpp
    struct RootsCapability {
        std::optional<bool> listChanged;  // Client supports listChanged notifications

        RootsCapability() = default;
        explicit RootsCapability(bool list_changed) : listChanged(list_changed) {}
    };

    struct SamplingCapability {
        std::optional<bool> tools;  // Client supports tool use in sampling (CLNT-03)

        SamplingCapability() = default;
        explicit SamplingCapability(bool tools_enabled) : tools(tools_enabled) {}
    };

    struct ElicitationCapability {
        std::optional<bool> form;  // Client supports form mode (CLNT-04)
        std::optional<bool> url;   // Client supports URL mode (CLNT-05)

        ElicitationCapability() = default;
    };
    ```

    The builder already uses aggregate initialization which works with default-constructible structs,
    but explicit constructors make the intent clearer.
  </action>
  <verify>grep -A5 "struct RootsCapability" src/mcpp/protocol/capabilities.h | grep -q "RootsCapability(bool)"</verify>
  <done>Capability structs have constructors for easy builder use</done>
</task>

</tasks>

<verification>
After all tasks complete, verify:

1. ClientCapabilitiesBuilder class exists
2. Builder has methods: with_roots(), with_sampling(), with_elicitation_form(), with_elicitation_url(), with_elicitation(), with_experimental()
3. build() method returns ClientCapabilities
4. build_client_capabilities() free function exists for simple cases
5. Builder can be used fluently (method chaining)
6. Capability structs have appropriate constructors

Manual verification (code review):
- Read capabilities.h and confirm builder is well-documented
- Verify example usage in comments compiles conceptually
- Confirm no syntax errors
</verification>

<success_criteria>
1. ClientCapabilitiesBuilder class defined in capabilities.h
2. Fluent API with with_* methods for all capability types
3. build() method returns ClientCapabilities
4. build_client_capabilities() free function for simple cases
5. ClientCapabilities::Builder typedef points to builder class
6. Capability structs have constructors for easy initialization
</success_criteria>

<output>
After completion, create `.planning/phases/03-client-capabilities/03-08-SUMMARY.md` with:
- Frontmatter: phase: "03-client-capabilities", plan: "08", gap_closure: true
- Summary of ClientCapabilitiesBuilder implementation
- Fluent API methods available
- Example usage patterns
- Gap closed: "Helper method to configure client capabilities for initialization"
</output>
