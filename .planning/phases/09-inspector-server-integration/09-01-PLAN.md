---
phase: 09-inspector-server-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/mcpp/core/json_rpc.h
  - src/mcpp/core/json_rpc.cpp
autonomous: true

must_haves:
  truths:
    - "JsonRpcRequest::extract_request_id() helper extracts ID from raw JSON strings"
    - "Helper handles string IDs, numeric IDs, and null ID values"
    - "Helper returns null RequestId when ID field is missing or malformed"
    - "extract_request_id() is a static method on JsonRpcRequest struct"
  artifacts:
    - path: "src/mcpp/core/json_rpc.h"
      provides: "JsonRpcRequest::extract_request_id() declaration"
      contains: "static RequestId extract_request_id(std::string_view raw_json);"
    - path: "src/mcpp/core/json_rpc.cpp"
      provides: "JsonRpcRequest::extract_request_id() implementation"
      contains: "RequestId JsonRpcRequest::extract_request_id"
  key_links:
    - from: "examples/inspector_server.cpp"
      to: "JsonRpcRequest::extract_request_id()"
      via: "static method call in error handling"
      pattern: "extract_request_id\\(.*\\)"
---

<objective>
Add JsonRpcRequest::extract_request_id() helper for best-effort request ID extraction from potentially malformed JSON.

Purpose: When JSON-RPC request validation fails, parse error responses still need to include the request ID per JSON-RPC 2.0 spec. This helper extracts the ID field from raw JSON strings even when the JSON is malformed.

Output: Static helper method on JsonRpcRequest that returns RequestId (string, number, or null).
</objective>

<execution_context>
@/home/kotdath/.claude/get-shit-done/workflows/execute-plan.md
@/home/kotdath/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/09-inspector-server-integration/09-CONTEXT.md
@.planning/phases/09-inspector-server-integration/09-RESEARCH.md
@.planning/phases/08-bug-fix-foundation/08-01-SUMMARY.md

# Reference: Current fragile pattern in inspector_server.cpp (lines 367-401)
# This manual string search will be replaced by the helper:
# size_t id_pos = line.find("\"id\"");
# if (id_pos != std::string::npos) {
#     size_t colon_pos = line.find(":", id_pos);
#     ... 30+ lines of string manipulation
# }
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add extract_request_id() declaration to JsonRpcRequest</name>
  <files>src/mcpp/core/json_rpc.h</files>
  <action>
    Add a static method declaration to the JsonRpcRequest struct:

    ```
    /**
     * Extract request ID from raw JSON (best-effort for malformed requests)
     *
     * This helper attempts to extract the 'id' field even when the JSON
     * is malformed. Used for constructing parse error responses with
     * the correct request ID per JSON-RPC 2.0 spec.
     *
     * Handles three ID formats per JSON-RPC 2.0:
     * - String IDs: "id": "request-123"
     * - Numeric IDs: "id": 42
     * - Null IDs: "id": null
     *
     * Returns null RequestId (int64_t with value 0) when:
     * - The 'id' field is missing
     * - The 'id' value is malformed
     * - JSON parsing fails completely
     *
     * @param raw_json String containing the raw JSON request
     * @return Extracted ID as RequestId variant (int64_t, string, or null)
     */
    static RequestId extract_request_id(std::string_view raw_json);
    ```

    Add this declaration inside the JsonRpcRequest struct, after the from_json() declaration.
    DO NOT add to JsonRpcResponse or JsonRpcNotification - this is request-specific.
  </action>
  <verify>grep -q "static RequestId extract_request_id" src/mcpp/core/json_rpc.h</verify>
  <done>Declaration added with complete documentation describing behavior for all ID types</done>
</task>

<task type="auto">
  <name>Task 2: Implement extract_request_id() in json_rpc.cpp</name>
  <files>src/mcpp/core/json_rpc.cpp</files>
  <action>
    Implement the extract_request_id() static method:

    1. Pre-scan the raw JSON string for the "id" field key
    2. If found, parse the value after the colon
    3. Handle three cases:
       - Quoted string -> return std::string
       - Unquoted number -> return int64_t
       - null or malformed -> return int64_t(0) as null

    Implementation approach:
    - Use nlohmann::json::parse() first (fast path for valid JSON)
    - If parse succeeds but id exists, extract it directly
    - If parse fails, fall back to string search for "id" key
    - Extract value between : and next comma/brace
    - Return int64_t(0) for any failure case (null ID)

    Include the full implementation in json_rpc.cpp with the same header guard pattern as existing code.
  </action>
  <verify>grep -q "RequestId JsonRpcRequest::extract_request_id" src/mcpp/core/json_rpc.cpp</verify>
  <done>Implementation handles string IDs, numeric IDs, and returns null for missing/malformed IDs</done>
</task>

<task type="auto">
  <name>Task 3: Build and run tests to verify implementation</name>
  <files></files>
  <action>
    Build the library to verify compilation:
    1. cd /home/kotdath/omp/personal/cpp/mcpp
    2. cmake --build build --target mcpp
    3. Verify build succeeds without errors or warnings

    No new tests are required in this plan - the helper will be validated in the next plan when inspector_server.cpp uses it.
  </action>
  <verify>cmake --build build --target mcpp 2>&1 | tail -5</verify>
  <done>Library builds successfully; extract_request_id() is available for use in example server</done>
</task>

</tasks>

<verification>
- [ ] extract_request_id() declared in json_rpc.h with full documentation
- [ ] extract_request_id() implemented in json_rpc.cpp
- [ ] Library builds without errors or warnings
- [ ] Implementation handles string IDs, numeric IDs, and null returns
</verification>

<success_criteria>
JsonRpcRequest::extract_request_id() is available as a static method for use by example servers when constructing parse error responses.
</success_criteria>

<output>
After completion, create `.planning/phases/09-inspector-server-integration/09-01-SUMMARY.md`
</output>
